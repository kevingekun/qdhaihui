
(function(){var _chartCache={},_currentId=null;(function(){var runPointActions=Highcharts.Pointer.prototype.runPointActions;Highcharts.Pointer.prototype.runPointActions=function(e){var pointer=this,math=Math,mathMax=math.max,mathMin=math.min,mathAbs=math.abs,chart=pointer.chart,series=chart.series,tooltip=chart.tooltip,point,points,hoverPoint=chart.hoverPoint,hoverSeries=chart.hoverSeries,i,j,distance=chart.chartWidth,index=pointer.getIndex(e),anchor;if(tooltip&&pointer.options.tooltip.shared&&!(hoverSeries&&hoverSeries.noSharedTooltip)){points=[];i=series.length;for(j=0;j<i;j++){if(series[j].visible&&series[j].options.enableMouseTracking!==false&&!series[j].noSharedTooltip&&series[j].tooltipPoints.length){point=series[j].tooltipPoints[index];if(point.series){point._dist=mathAbs(index-point.clientX);distance=mathMin(distance,point._dist);points.push(point);}}}
i=points.length;while(i--){if(points[i]._dist>distance){points.splice(i,1);}}
if(points.length&&(points[0].clientX!==pointer.hoverX)){points[0].firePointEvent('mouseOver');}}
runPointActions.call(this,e);};})();GDT.highchart=QBL.highchart=GDT.highchart||{};J.extend(GDT.highchart,{create:function(data,options){var $=window.jQuery;options.showFields=options.showFields||options.showFileds;options.xAxisField=options.xAxisField||options.xAxisFiled||'statsdate';options=$.extend({target:null,dataType:'一个位置的多指标图',type:'line',showFields:null,showFieldsOpts:null,xAxisField:'statsdate',baseField:'',title:'',subTitle:'',pieDesc:'数量',fieldNameMap:null,colorMap:{},colors:null,legend:null,percentFields:[],percentFieldsNeedMultiply100:true,startDate:null,endDate:null,disableLegendForSingleSeries:true,yaxisMin:0,extraHighchartsOptions:null,pointMouseOver:null},options);var op=options;GDT.log('options are',options);op.target.get&&(op.target=op.target.get(0));var ChartPack=function(data,options){this.data=data;this.options=options;this.chart=null;};ChartPack.prototype.destroy=function(){this.chart.destroy();};ChartPack.prototype.init=function(){Highcharts.setOptions({global:{useUTC:false}});};ChartPack.prototype.showFields=function(fieldArray,opts){GDT.log('chart> showfields> ',fieldArray,opts);var uniqueNames=[];if($.isArray(fieldArray)){$.each(fieldArray,function(i,el){if($.inArray(el,uniqueNames)===-1)uniqueNames.push(el);});fieldArray=uniqueNames;}
var isDate=null;var middleData={};var middleDatas={};var data=this.data,options=this.options,op=options,type=options.type;var nowTime=new Date();GDT.log('chart: fieldArray:',fieldArray);var isZero={};function procCellNotTime(fieldKey,value){var toreturn;if($.inArray(fieldKey,options.percentFields)>-1){if(op.percentFieldsNeedMultiply100){toreturn=(parseFloat(value)*100)}else{toreturn=(parseFloat(value))}}else{toreturn=(parseFloat(value))}
if(!(fieldKey in isZero)){isZero[fieldKey]=true;}
if(value!=0){isZero[fieldKey]=false;}
return toreturn;}
function procCellTime(fieldKey,value){var reDateWithMinus=/^[0-9]{4}\-[0-9]{1,2}\-[0-9]{1,2}$/;var reDate8num=/^[0-9]{8}$/;var reHourAndMinuteWithColon=/^[0-9]{2}\:[0-9]{2}$/;var reHourNum=/^[0-9]{1,2}$/;var timeStamp;var queryYear,queryMonth,queryDay;if(options.startDate){var dateArray=options.startDate.replace(/-/g,"/").split('/');queryYear=parseInt(dateArray[0],10);queryMonth=parseInt(dateArray[1],10)-1;queryDay=parseInt(dateArray[2],10);}else{queryYear=nowTime.getFullYear();queryMonth=nowTime.getMonth();queryDay=nowTime.getDate();}
if(reDateWithMinus.test(value)){isDate=true;timeStamp=Date.parse(value.replace(/-/g,"/"));}else if(reDate8num.test(value)){isDate=true;timeStamp=(new Date(parseInt(value.substring(0,4),10),parseInt(value.substring(4,6),10)-1,parseInt(value.substring(6,8),10))).getTime();}else if(reHourAndMinuteWithColon.test(value)){var s=value.split(':');isDate=false;timeStamp=(new Date(queryYear,queryMonth,queryDay,parseInt(s[0],10),parseInt(s[1],10))).getTime();}else if(reHourNum.test(value)){isDate=false;timeStamp=(new Date(queryYear,queryMonth,queryDay,parseInt(value,10),0)).getTime();}else{throw('can not recognize the date formate: '+value);}
return timeStamp;}
if(type=='line'){if(op.dataType=='一个位置的多指标图'){$.each(data.list,function(k,one){$.each([options.xAxisField].concat(fieldArray),function(number,fieldKey){var value=one[fieldKey];if(!(fieldKey==op.xAxisField||$.inArray(fieldKey,fieldArray)>-1)){return;}
if(!(fieldKey in middleData)){middleData[fieldKey]=[];}
if(fieldKey!=op.xAxisField){middleData[fieldKey].push(procCellNotTime(fieldKey,value))}else{middleData[fieldKey].push(procCellTime(fieldKey,value));}})});}else if(op.dataType=='多个位置的单指标图'){$.each(data,function(tid,onepos){if(J.inArray(tid,opts.tids)<0){return;}
var posname=onepos.name;var posdata=onepos.data;middleData={_name:posname,_tid:tid,_color:onepos.color};$.each(posdata,function(k,one){$.each([options.xAxisField,opts.field],function(number,fieldKey){var value=one[fieldKey];if(!(fieldKey in middleData)){middleData[fieldKey]=[];}
if(fieldKey!=op.xAxisField){middleData[fieldKey].push(procCellNotTime(fieldKey,value))}else{middleData[fieldKey].push(procCellTime(fieldKey,value));}})});GDT.log('>calc middledata > one middleData >',J.extend(true,{},middleData));middleDatas[tid]=(middleData);});}}else if(type=='pie'){if(options.showFields.length>1){throw('pie chart can only show one field,check showFields option');}
$.each(data.list,function(k,one){var keyName=options.baseField;var valueName=options.showFields[0];var key=one[keyName];var value=parseFloat(one[valueName]);middleData[key]=value;});}else if(type=='column'){$.each(data.list,function(k,one){var keyName=options.baseField;var valueName=options.showFields[0];var key=one[keyName];var value=parseFloat(one[valueName]);middleData[key]=value;});}
GDT.log('>chart  >middleData is:',J.extend(true,{},middleDatas));var allZero=false;J.each(isZero,function(k,one){if(one==true){allZero=true;return false}});var xasic=[];var yasic=[];var series=[];var count=0;var timeInterval=24*3600*1000;var minRange,pointRange;function geneOneLine(fieldkey,name,linedata,count,color,series,yasic,times,noNewYaxis){var ones={};ones.name=name;ones.data=linedata;var len=times.length;for(var i=0;i<len;i++){ones.data[i]=[times[i],ones.data[i]];}
ones.yAxis=count;ones.tooltip={valueSuffix:($.inArray(fieldkey,options.percentFields)>-1)?'%':null,valueDecimals:($.inArray(fieldkey,options.percentFields)>-1)?2:null};ones.color=color;pointRange&&(ones.pointRange=pointRange);series.push(ones);GDT.log('>gen one line > one , series:',ones,series);(!noNewYaxis)&&yasic.push({title:{text:((GDT.ENV&&GDT.ENV.highchartsHideYaxisTitle)?null:ones.name)},opposite:count!=0,min:op.yaxisMin,minRange:allZero?1:null,labels:{formatter:function(){if(this.value<0){return null;}else{if($.inArray(fieldkey,options.percentFields)>-1){return(this.value)+' %'}else{return this.value;}}}}});}
if(type=='line'){if(op.dataType=='一个位置的多指标图'){if(!middleData[options.xAxisField]){throw('IN GDT.highchart :no data 没有数据（至少没有X轴数据），请检查');}
if(!isDate){timeInterval=3600*1000;}
if(middleData[options.xAxisField].length>1){timeInterval=(middleData[options.xAxisField][1]-middleData[options.xAxisField][0]);minRange=null;pointRange=null;}else{timeInterval=null;minRange=24*3600*1000;pointRange=24*3600*1000;}
var colors=null;if(GDT.ENV&&GDT.ENV.highchartsLinesColor){colors=GDT.ENV.highchartsLinesColor;}
if(op.colors){colors=op.colors;}
GDT.log('colors',colors,op.colors);count=0;$.each(middleData,function(k,v){if(k==op.xAxisField){xasic=v;}else{geneOneLine(k,op.fieldNameMap?(op.fieldNameMap[k]||k):k,v,count,colors&&colors[count]?colors[count]:null,series,yasic,middleData[options.xAxisField]);count+=1;}});}else if(op.dataType=='多个位置的单指标图'){GDT.log('>before gen one line 4',J.extend(true,{},middleDatas));var yaxisAlreadyOk=false;count=0;J.each(middleDatas,function(ak,onemiddleData){GDT.log('>before gen one line 3',ak,onemiddleData);J.each(onemiddleData,function(k,v){GDT.log('>before gen one line 2 ',k,v);if(k.charAt(0)=='_'){return;}else if(k==op.xAxisField){xasic=v;if(v.length>1){timeInterval=(v[1]-v[0]);minRange=null;pointRange=null;}else{timeInterval=null;minRange=24*3600*1000;pointRange=24*3600*1000;}}else{GDT.log('>before gen one line 多个位置的单指标图 ',k,v,yaxisAlreadyOk);geneOneLine(k,''+onemiddleData._name+'-'+(op.fieldNameMap?(op.fieldNameMap[k]||k):k),v,0,onemiddleData._color||null,series,yasic,middleData[options.xAxisField],yaxisAlreadyOk);if(!yaxisAlreadyOk){yaxisAlreadyOk=true}
count+=1;}});})}
GDT.log('>chart  >before xasic  is:',xasic);GDT.log('>chart  >before series  is:',series);GDT.log('>chart  >before yasic  is:',yasic);}else if(type=='pie'){series=[{type:'pie',name:options.pieDesc,data:[]}];J.each(middleData,function(k,v){var ones={};ones.type='pie';ones.name=op.fieldNameMap?(op.fieldNameMap[k]||k):k;ones.y=v;(options.colorMap[k])&&(ones.color=options.colorMap[k]);series[0].data.push(ones);});}else if(type=='column'){series=[{type:'column',data:[]}];J.each(middleData,function(k,v){var ones={};ones.type='column';ones.name=op.fieldNameMap?(op.fieldNameMap[k]||k):k;xasic.push(op.fieldNameMap?(op.fieldNameMap[k]||k):k);if(typeof op.fieldFormat==='function'){ones.y=op.fieldFormat(v);}else{ones.y=v;}
if(options.colorMap[k]){ones.color=options.colorMap[k];}
series[0].data.push(ones);});}
if(type=='line'){var highOp={chart:{type:'line',renderTo:op.target,marginBottom:25},title:{text:op.title},subtitle:{text:op.subTitle},xAxis:{type:'datetime',minRange:minRange,dateTimeLabelFormats:{millisecond:'%Y-%m-%d',second:'%Y-%m-%d',minute:'%Y-%m-%d',hour:'%H:%M',day:'%m-%d',week:'%m-%d',month:'%Y-%m-%d',year:'%Y-%m-%d'},labels:{formatter:function(){if(J.inArray(this.value,middleData[options.xAxisField])>-1){return Highcharts.dateFormat(this.dateTimeLabelFormat,this.value);}else{return null;}}}},yAxis:yasic,tooltip:{dateTimeLabelFormats:{millisecond:'%Y-%m-%d',second:'%Y-%m-%d',minute:'%Y-%m-%d',hour:'%Y-%m-%d %H:%M',day:'%Y-%m-%d',week:'%Y-%m-%d',month:'%Y-%m-%d',year:'%Y-%m-%d'},style:{fontSize:'12px',padding:'8px'}},legend:op.legend||{align:'right',verticalAlign:'top',layout:'vertical',x:-40,y:10,floating:true,enabled:(op.disableLegendForSingleSeries&&fieldArray.length==1)?false:true},series:series,credits:{enabled:false},plotOptions:{line:{events:{legendItemClick:function(e){if(count<2){return false;}else{return true;}}}},"series":{"point":{"events":{mouseOver:op.pointMouseOver||null}}}}};highOp=J.extend(true,highOp,op.extraHighchartsOptions);this.chart=new Highcharts.Chart(highOp);}else if(type=='column'){var highOp={chart:{type:'column',renderTo:op.target},credits:{enabled:false},plotOptions:{series:{shadow:false,borderWidth:3,dataLabels:{enabled:true,formatter:function(){return'<b>'+this.y.toFixed(2)+'%</b>';}}}},title:{text:op.title},tooltip:{pointFormat:'<b>{point.y}'+op.suffix+'</b>',percentageDecimals:1},xAxis:{categories:xasic},yAxis:{title:{text:''}},legend:{enabled:false},series:series};highOp=J.extend(true,highOp,op.extraHighchartsOptions);this.chart=new Highcharts.Chart(highOp);}else if(type=='pie'){var highOp={chart:{type:'pie',renderTo:op.target},title:{text:op.title},tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b>，占比：<b>{point.percentage:.2f}%</b>',percentageDecimals:1},plotOptions:{pie:{allowPointSelect:true,cursor:'pointer',shadow:true,borderWidth:3,dataLabels:{enabled:false,color:'#000000',connectorColor:'#000000',format:'<b>{point.name}</b>: {point.percentage:.1f} %'},showInLegend:true,point:{events:{legendItemClick:function(e){return false;}}}}},series:series,credits:{enabled:false}};highOp=J.extend(true,highOp,op.extraHighchartsOptions);this.chart=new Highcharts.Chart(highOp);}};var a=new ChartPack(data,options);a.init();a.showFields(options.showFields,options.showFieldsOpts);return a;}});GDT.chart=QBL.charter=GDT.chart||{};J.extend(GDT.chart,{swfPath:GDT.commpath+'/chart.swf',get:function(chartId){return _chartCache[chartId||_currentId];},insertTo:function(elOrId,opts){var el=elOrId,chartId,chart,wrap,width,height;if(typeof elOrId==='string'){el=$(elOrId);}
if(el.nodeType!==1){return false;}
opts=opts||{};do{chartId=Math.ceil(Math.random()*100);}while(typeof _chartCache[chartId]!=='undefined');width=opts.width||"100%";height=opts.height||"350";el.innerHTML=QZFL.media.getFlashHtml({src:GDT.chart.swfPath,width:width,height:height,allowScriptAccess:"always",allowFullScreen:'false',flashVars:'loadType=js&readyCallBack=noCallBack',quality:'high',bgcolor:opts.bgcolor||'#ffffff',scaleMode:'noScale',id:'_GDT_CHART'+chartId,name:'_GDT_CHART'+chartId,wmode:'opaque'});chart=$('_GDT_CHART'+chartId);_chartCache[chartId]=chart;_currentId=chartId;return chart;},loadJsonData:function(data,chart){chart=chart||GDT.chart.get();if(chart&&chart.loadJsonObject){try{chart.loadJsonObject(data);}catch(e){GDT.util.showMsgbox('Flash图表加载数据出错');}}else{var args=arguments,fn=args.callee,_checkFlash;_checkFlash=setInterval(function(){if(chart&&chart.loadJsonObject){clearInterval(_checkFlash);fn.apply(GDT.chart,Array.prototype.slice.call(args));}},200);}}});})();
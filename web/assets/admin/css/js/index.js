
(function(VIndex){var $=J,TIPS={'t1':'<span class="c-red">您的账户信息不完整，广告将无法正常推广，请尽快补全信息。点击进入</span><a href="'+GDT.route.genRealUrl('tool/profile')+'">账户中心</a><a class="close" title="关闭" href="javascript:;" data-msgtype="t1"></a>','t2':'<span class="c-red">您的账户资料审核不通过，为保证广告投放，请尽快修改。点击进入</span><a href="'+GDT.route.genRealUrl('tool/profile')+'">账户中心</a><a class="close" title="关闭" href="javascript:;" data-msgtype="t2"></a>','t3':'<span class="c-red">您的账户余额不足，为保证广告投放，请尽快充值。点击进入</span><a href="'+GDT.route.genRealUrl('account/info')+'">财务信息</a><a class="close" title="关闭" href="javascript:;" data-msgtype="t3"></a>','t4':'<span class="c-red">您的今日消耗已达账户日限额，为保证广告投放，请尽快修改日限额。点击进入</span><a href="'+GDT.route.genRealUrl('account/info')+'">财务信息</a><a class="close" title="关闭" href="javascript:;" data-msgtype="t4"></a>','t5':'<span class="c-red">您的今日消耗已达账户日限额的85%，为保证广告投放，请尽快修改日限额。点击进入</span><a href="'+GDT.route.genRealUrl('account/info')+'">财务信息</a><a class="close" title="关闭" href="javascript:;" data-msgtype="t5"></a>'},MIndex=GDT.modIndex;VIndex.USERKEY='user';VIndex._tpl_orderlist=['<legend class="tit"><strong>最近更新广告</strong></legend>','<ul class="inner">','<%var i=0,len=list.length;%>','<%for(;i<len;i++){ var row=list[i]; %>','<li class=""><a rel="<%=row.orderid%>" href="javascript:;" class="" title="<%=row.ordername%>"><span><%=J.cut(row.ordername, 24, "...")%></span></a></li>','<% } %>','</ul>'].join('');VIndex._tpl_account=$('#tpl_account').html();VIndex._tpl_orderstatics=$('#tpl_orderstatics').html();['<h3>广告统计</h3>','<ul>','<li><span class="tit">待审核</span><a href="'+GDT.ENV.HTMLPATH+'report/order?status=2" class="nums"><%=unaudit%></a></li>','<li><span class="tit">今日新增</span><a class="nums" style="cursor: default;"><%=increment%></a></li>','<li><span class="tit">未通过</span><a  href="'+GDT.ENV.HTMLPATH+'report/order?status=3" class="nums c-red"><%=failedaudit%></a></li>','<li><span class="tit">有效广告</span><a  class="nums"  style="cursor: default;"><%=onlinead%></a></li>','</ul>'].join("\r\n");VIndex._tpl_ordernav='<a href="report/order?cid=<%=campaignid%>" rel="<%=campaignid%>"><%=campaignname%></a><span class="sep">></span><a href="report/order?oid=<%=orderid%>"><%=ordername%></a>';VIndex._tpl_rptsum=$('#tpl_rptsum').html();VIndex.init=function(){GDT.log('i am index');GDT.speed.create('modIndex',[175,384,1]);GDT.page.init();VIndex.initChartForm();J('#main').addClass("home");VIndex.initEvent();GDT.beautyUI.showLoading("orderlist",{minHeight:'700px'});MIndex.loadOrderlist();J("#usersummary").attr('rel',VIndex.USERKEY).trigger("click");};VIndex.getReginfo=function(cb,errCb){var url='/api.php?mod=aduser&act=reginfo';QBL.getter(url,{},cb,{errcbFn:errCb});}
VIndex.initEvent=function(){J("#orderlist").parent().parent().on('click','a',function(evt){VIndex.orderselected(evt);evt.preventDefault();GDT.util.reportHottag('index.tree');return false;});};VIndex.setLinkWidth=function(){var nw,w,mw,m=J('#chartnav').parent();nw=m.outerWidth();J('#__linkbar').width(nw);};VIndex.showOrderList=function(d){GDT.beautyUI.hideLoading("orderlist");if(d.ret===0){var da=d.data,cnt;GDT.log('index get orderlist data',da);GDT.modIndex.indexOrder(da.list);cnt=J('#orderlist');cnt.html(GDT.util.tmpl(VIndex._tpl_orderlist,da));}
setTimeout(function(){var h=J('.main-menu').outerHeight()+15;J('.main-container').css('min-height',h);},100);};VIndex.orderselected=function(evt){var cnt=J("#orderlist").parent().parent();var target=J(evt.currentTarget),orderid;GDT.log('index page order list click target ',target);orderid=J(target).attr('rel');if(orderid){var userinfocnt=J('#userinfocnt'),ordercnt=J('#ordernav').parent();cnt.find('a').removeClass('current');target.addClass("current");if(orderid!=VIndex.USERKEY){VIndex.setOrderInfo(orderid);userinfocnt.addClass('none');}else{VIndex.setOrderInfo();userinfocnt.removeClass('none');VIndex.loadUserData();}
GDT.viewIndex.loadChartData(orderid);}};var _period={1:'过去30天',2:'过去7天',3:'昨天',4:'今天'},_periodDays={1:30,2:7,3:1,4:0};VIndex.changePeriod=function(){VIndex.loadChartData();};VIndex.charttype='';VIndex.loadUserData=function(){var loadaccount=function(){var defArr=[J.Deferred(),J.Deferred()];GDT.cgiAccount.getInfo(function(o){if(o&&o.ret===0){defArr[0].resolve(o);}else{GDT.beautyUI.showLoadError("useraccount",loadaccount);}},function(){GDT.beautyUI.showLoadError("useraccount",loadaccount);},{loading:{container:'useraccount',timeout:3000}});GDT.load([GDT.files.getVersionFile('modaccountstat')],function(){defArr[1].resolve();});J.when(defArr[0],defArr[1]).done(function(o){var wrap=J("#useraccount");var timer=null;var accountDislayCfg={0:{clsPrefix:'cash',fontCls:'c-red'},1:{clsPrefix:'virtual',fontCls:'c-gre'},3:{clsPrefix:'swop',fontCls:'c-yellow',tips:'只用于”应用宝换量应用”商品投放的消耗，且推广"应用宝换量应用"时，优先消耗该账户的资金。'},4:{clsPrefix:'swop',fontCls:'c-yellow',tips:'只用于”应用宝换量应用”商品投放的消耗，且推广"应用宝换量应用"时，优先消耗该账户的资金。'},5:{clsPrefix:'overdraft',fontCls:'c-yellow',tips:'当现金、虚拟账户中均没有余额后，消耗该账户的资金'},7:{clsPrefix:'redsea',fontCls:'c-palered',tips:'只用于红海广告位的投放消耗，且投放红海广告位时，优先消耗该账户的资金。'},8:{clsPrefix:'bluesea',fontCls:'c-blue',tips:'只用于蓝海广告位的投放消耗，且投放蓝海广告位时，优先消耗该账户的资金。'},9:{clsPrefix:'cash',fontCls:'c-red',tips:'只用于微信／移动feeds广告位的投放消耗，且投放微信／移动feeds广告位时，优先消耗该账户的资金'},10:{clsPrefix:'cash',fontCls:'c-red',tips:'只用于微信／移动feeds广告位的投放消耗，且投放微信／移动feeds广告位时，优先消耗该账户的资金'},11:{clsPrefix:'cash',fontCls:'c-red',tips:'只用于微信／移动feeds广告位的投放消耗，且投放微信／移动feeds广告位时，优先消耗该账户的资金'}};o=GDT.modAccountStat.parseData(o);o.data.getClsPrefix=function(id){return(id in accountDislayCfg)?accountDislayCfg[id].clsPrefix:accountDislayCfg[GDT.modAccountStat.accountTypeDef.CASH].clsPrefix;};o.data.getFontCls=function(id){return(id in accountDislayCfg)?accountDislayCfg[id].fontCls:accountDislayCfg[GDT.modAccountStat.accountTypeDef.CASH].fontCls;};o.data.getTips=function(id){return(id in accountDislayCfg)?accountDislayCfg[id].tips:'';};o.data.isSpecialAccount=function(foundType){return foundType==2;};wrap.html(GDT.util.tmpl(VIndex._tpl_account,o.data));wrap.find('div.zhanghu-zhuan').hover(function(){$(this).find('.zhuan-explain').removeClass('none');},function(){$(this).find('.zhuan-explain').addClass('none');});GDT.privilegeElementShow();});};loadaccount();var loadstatics=function(){GDT.cgiAccount.getAdstatic(function(o){GDT.beautyUI.hideLoading("orderstatics");if(o&&o.ret===0){J("#orderstatics").html(GDT.util.tmpl(VIndex._tpl_orderstatics,o.data));}else{GDT.beautyUI.showLoadError("orderstatics",loadstatics);}},function(){GDT.beautyUI.showLoadError("orderstatics",loadstatics);},{loading:{container:'orderstatics',timeout:3000}});};loadstatics();};VIndex.initChartForm=function(){var wrap=J('#chartnav'),period,axisleft,axisright,rptFieldMap={},daytype;J.each(GDT.confReport.chartFields,function(k,v){rptFieldMap[v]=GDT.confReport.fieldsNameMapping[v];});axisleft=wrap.find('._js_axisleft');axisright=wrap.find('._js_axisright');GDT.util.initMapSelect(axisleft[0],rptFieldMap,GDT.confReport.chartDefaultFields[0],{noempty:true});GDT.util.initMapSelect(axisright[0],rptFieldMap,GDT.confReport.chartDefaultFields[1],{noempty:true});axisleft.bind('change',function(){var params;params=VIndex._getFormData();VIndex.showChart(null,params);});axisright.bind('change',function(){var params;params=VIndex._getFormData();VIndex.showChart(null,params);});};var _extParams={};VIndex.setRptParam=function(key,value){_extParams[key]=value;};VIndex._getFormData=function(){var params,wrap,axisleft,axisright,period,now=GDT.util.getTime(),sdate,edate,daynum,daysec=86400000,periodel;wrap=J('#chartnav');axisleft=J('._js_axisleft',wrap).val();axisright=J('._js_axisright',wrap).val();periodel=J('#_js_rptperiod');GDT.log('>>get 日期 select : ',J('#_js_rptperiod'));if(periodel.length>0){period=periodel.val();}
if(!period){period=J.timeFormatString(now,'{h}')<'09'?2:4;}
daynum=_periodDays[period];edate=J.timeFormatString(now-(daysec*(daynum>0?1:0)),'{Y}-{M}-{d}');sdate=J.timeFormatString(now-daysec*daynum,'{Y}-{M}-{d}');params={format:'json',page:1,pagesize:10,sdate:sdate,edate:edate,period:period,searchact:axisleft+'|'+axisright,dimension:'viewcount'};J.extend(params,_extParams);return params;};VIndex.loadChartData=function(orderid){var charttype=orderid||VIndex.charttype;if(charttype!=VIndex.USERKEY){VIndex.loadOrderChartData(orderid);}else{VIndex.loadUserChartData();}
VIndex.charttype=charttype;};VIndex.loadOrderChartData=function(orderid){var params;orderid&&VIndex.setRptParam('orderid',orderid);params=VIndex._getFormData();GDT.log('order rpt form data',params);GDT.beautyUI.showLoading("_chartWrap",3000);GDT.cgiReport.adgroupdetail(params,function(d){VIndex.dealChartData(d,params);});};VIndex.loadUserChartData=function(){var params;VIndex.setRptParam('orderid','');params=VIndex._getFormData();GDT.log('rpt form data',params);GDT.beautyUI.showLoading("_chartWrap",3000);GDT.cgiReport.summary(params,function(d){VIndex.dealChartData(d,params);});};VIndex.dealChartData=function(d,params){if(d.ret===0){var list=[],now=J.timeFormatString(GDT.util.getTime(),'{Y}-{M}-{d}');list=GDT.listdataFormater(d.data.list);list=GDT.chartdataFormater(list);GDT.modIndex._chartData=list;VIndex.showChart(list,params);VIndex.renderTotal(d.data.list,params);d.data.notice&&J('#_notice').html(d.data.notice);}else{GDT.util.showMsgbox(d.msg||'获取报表信息失败，请稍后再试');}};VIndex.renderTotal=function(list,formdata){list=J.extend(true,{},list);GDT.helper.getReportSumData(list,{format:'number'},function(total){GDT.log('VIndex.renderTotal> total is :',J.extend(true,{},total));var cnt,promfield=['viewcount','validclickcount','cost'],f;cnt=J('#rptSumCnt');if(cnt.size()==0){cnt=J('<div id="rptSumCnt" class="time-data"></div>');cnt.insertAfter(J('#chartnav div:eq(0)'));}
total=total||{};total.datetype=_period[formdata.period];f=function(field){var val;total[field+'Quantity']='';val=total[field];if(val>1e10){total[field]=(total[field]/1e8).toFixed(2);total[field+'Quantity']='亿';}
if(val>1e7){total[field]=parseInt(total[field]/1e4);total[field+'Quantity']='万';}};J.each(promfield,function(k,v){f(v);});GDT.log('VIndex.renderTotal> total2 is :',J.extend(true,{},total));total=GDT.listdataFormater([total]).pop();GDT.log('VIndex.renderTotal> total3 is :',J.extend(true,{},total));cnt.html(GDT.util.tmpl(VIndex._tpl_rptsum,total));GDT.log('>>init 日期 select : ',J('#_js_rptperiod'));J('#_js_rptperiod').empty();GDT.util.initMapSelect(J('#_js_rptperiod')[0],_period,formdata.period,{noempty:true});J('#_js_rptperiod').unbind('change').bind('change',VIndex.changePeriod);});};VIndex.showChart=function(data,params){var dataFields={},showFileds,config,_me=GDT.modIndex;data=data||_me._chartData;showFileds=params.searchact.split('|');var charts=window.charts=[];var timer=null;function refreshData(jdom,data){if(jdom.parent().parent().is('.resolve-chart')){jdom.parent().parent().find('h3 span:first').text(data);}}
function syncTooltip(container,p){if(timer){clearTimeout(timer);}
var i=0,j=0,data;for(;i<charts.length;i++){{data=charts[i].series[0].xData;var index=J.inArray(p,data);if(index>=0){var points=[];J.each(charts[i].series,function(k,one){points.push(one.data[index])});if(container.id!=charts[i].container.id){charts[i].tooltip.refresh(points);}
refreshData(J(charts[i].container).parent(),points[0].y);}}}}
config={title:'',showFileds:showFileds,fieldNameMap:GDT.confReport.fieldsNameMapping,percentFields:GDT.confReport.percentFields,percentFieldsNeedMultiply100:false,target:J("#_chartWrap"),startDate:params.sdate,pointMouseOver:function(){syncTooltip(this.series.chart.container,this.x);},extraHighchartsOptions:{"tooltip":{"shared":"true","crosshairs":"true"}}};GDT.log('chart data',data,'chart conf',config);charts.push(GDT.highchart.create({list:data},config).chart);var subchartsFields=['viewcount','validclickcount','ctr','cost'];var tcount=0;var subchartwrap=J("#_subchartswrap");subchartwrap.removeClass('none');J('div.resolve-chart',subchartwrap).each(function(){var jthis=J(this);var chartCon=jthis.find('div.fls');chartCon.height('140px');var con={title:'',legend:{enabled:false},showFileds:[subchartsFields[tcount]],percentFields:GDT.confReport.percentFields,percentFieldsNeedMultiply100:false,fieldNameMap:GDT.confReport.fieldsNameMapping,target:chartCon,startDate:params.sdate,colors:['#43ccd1'],pointMouseOver:function(){syncTooltip(this.series.chart.container,this.x);},extraHighchartsOptions:{plotOptions:{series:{fillColor:'#c5edf1',fillOpacity:0.2}},chart:{type:'area'},"tooltip":{"shared":"true","crosshairs":"true",positioner:function(){return{x:-100,y:-100};}}}};var c=GDT.highchart.create({list:data},con).chart;charts.push(c);GDT.log("J('#_subchartswrap div.resolve-chart').each",charts);tcount++;});if(!_me._report.antiDouble){GDT.speed.mark(2);_me.checkReport();_me._report.antiDouble=true;}};VIndex.setOrderInfo=function(orderid){if(orderid){var orderinfo=GDT.modIndex.getOrderInfo(orderid);orderinfo&&J('#ordernav').html(GDT.util.tmpl(VIndex._tpl_ordernav,orderinfo));}else{J('#ordernav').html('整体情况<span class="cft-attention c-tx3">（以下数据有近三十分钟的统计延迟）</span>');}};})(GDT.viewIndex={});
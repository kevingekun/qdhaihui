
window.GDT=window.GDT||{};GDT.util=GDT.util||{};GDT.cgiReport=GDT.cgiReport||{};GDT.modReport=GDT.modReport||{};(function(){var F=GDT.formater;QZFL.object.extend(GDT.formater,{sortFormart:function(s){return isNaN(s)?s.replace(/,/g,'').replace('%','').replace(/-/g,'').replace(/:/g,''):s;}});QZFL.object.extend(GDT.util,{filterToday:function(datastr){var time=GDT.util.getTime(),now=QZFL.string.timeFormatString(time,'{Y}-{M}-{d}');return datastr==now?QZFL.string.timeFormatString(time-GDT.constDate.DAY1,'{Y}-{M}-{d}'):datastr;}});var CGI;CGI=GDT.cgiReport;QZFL.object.extend(CGI,GDT.report);QZFL.object.extend(CGI,{price:function(orderid,cb,errCb){GDT.getter('/api.php?mod=order&act=price',{aid:orderid},function(d){if(d.ret==0){GDT.ENV.PRICE_MIN=GDT.ENV.CPMPRICE_MIN=d.data.minprice;GDT.ENV.PRICE_MAX=d.data.maxprice;}
cb(d);},{errcbFn:errCb,ozid:400512});},delAll:function(alist,cb,errCb){GDT.sender('/api.php?mod=order&act=delbatch',{aidlist:alist},cb,{errcbFn:errCb,ozid:400532});},setOrderStatus:function(ids,status,cb,errCb){GDT.sender('/api.php?mod=order&act=batsetstatus',{aidlist:ids,status:status},cb,{errcbFn:errCb,ozid:440062});},setOrderPrice:function(ids,feeprice,cb,errCb){GDT.sender('/api.php?mod=order&act=batsetprice',{aidlist:ids,feeprice:feeprice},cb,{errcbFn:errCb,ozid:440063});}});GDT.listdataFormater=function(list){var result=[],handlerMap=GDT.confReport.showHandler,fields=GDT.confReport.tableFields;J.each(list,function(i,item){var row=item;J.each(fields,function(i,f){if(f in handlerMap){row[f]=handlerMap[f].call(null,item);}});result.push(row);});return result;};GDT.chartdataFormater=function(list){list=J.extend(true,{},list);var result=[],now=QZFL.string.timeFormatString(GDT.util.getTime(),'{Y}-{M}-{d}');J.each(list,function(ak,item){var row={};row=item;J.each(item,function(k,n){isNaN(n)&&(n=n.replace(/,/g,'').replace('%',''));(n<0||n=='-')&&(n=0);row[k]=n;});if(row.statsdate==now){'clicktraderate'in row&&(row.clicktraderate=-1);'tradecount'in row&&(row.tradecount=-1);}
result.push(row);});return result;};GDT.reportModel={dateEventFn:function(onchange,idMap){idMap=idMap||{};return{today:function(){var now=GDT.util.getTime();!QZFL.lang.isFunction(onchange)&&(onchange=function(){});QBL.calendar.setDate(idMap.sdate||'sdate',now);QBL.calendar.setDate(idMap.edate||'edate',now);onchange();return false;},yesterday:function(evt){var yeterday=GDT.util.getTime()-GDT.constDate.DAY1;!QZFL.lang.isFunction(onchange)&&(onchange=function(){});QBL.calendar.setDate(idMap.sdate||'sdate',yeterday);QBL.calendar.setDate(idMap.edate||'edate',yeterday);onchange();return false;},last7days:function(evt){var now=GDT.util.getTime();!QZFL.lang.isFunction(onchange)&&(onchange=function(){});QBL.calendar.setDate(idMap.sdate||'sdate',now-GDT.constDate.DAY6);QBL.calendar.setDate(idMap.edate||'edate',now);onchange();return false;},last30days:function(evt){var now=GDT.util.getTime();!QZFL.lang.isFunction(onchange)&&(onchange=function(){});QBL.calendar.setDate(idMap.sdate||'sdate',now-GDT.constDate.DAY29);QBL.calendar.setDate(idMap.edate||'edate',now);onchange();return false;},last7daysWithoutToday:function(evt){var now=GDT.util.getTime();!QZFL.lang.isFunction(onchange)&&(onchange=function(){});QBL.calendar.setDate(idMap.sdate||'sdate',now-GDT.constDate.DAY7);QBL.calendar.setDate(idMap.edate||'edate',now-GDT.constDate.DAY1);onchange();return false;},last30daysWithoutToday:function(evt){var now=GDT.util.getTime();!QZFL.lang.isFunction(onchange)&&(onchange=function(){});QBL.calendar.setDate(idMap.sdate||'sdate',now-GDT.constDate.DAY30);QBL.calendar.setDate(idMap.edate||'edate',now-GDT.constDate.DAY1);onchange();return false;}};},getStatusCampaignCanBe:function(nowStatus){var statuslist,slist=[];statuslist=GDT.ENV.statelist[nowStatus]['olist'];if(!statuslist){return;}
QZFL.object.each(statuslist,function(v){if(v!=20){slist.push(v);}});return slist;},setCampaignStatus:function(triggleEl,data,onSuccess){var statuslist,slist=[],str=['<ul class="pop_list" style="top:0;left:0;">'];data=data||{campaignid:'',status:''};if(GDT.ENV.statelist[data.status].disable){GDT.util.showMsgbox('暂无法操作，'+(triggleEl.getAttribute('title')||''));return;}
statuslist=GDT.ENV.statelist[data.status]['olist'];if(!statuslist){return;}
QZFL.object.each(statuslist,function(v){if(v!=20){slist.push(v);}});QZFL.object.each(GDT.helper.getStateListInfo(slist),function(status){str.push('<li><a href="javascript:;">'+status[1]+'</a><input type="hidden" value="'+status[0]+'" class="_val" /></li>');});str.push('</ul>');if(str.length<3){return;}
GDT.modifier.droplist(triggleEl,str.join(''),function(status){GDT.campaign.setStatus({campaignid:data.campaignid,status:status},function(d){if(d.ret===0){if(QZFL.lang.isFunction(onSuccess)){onSuccess(status);}
GDT.util.showMsgbox('修改推广计划状态成功',4);}else{GDT.util.showMsgbox(d.msg||'修改推广计划状态失败',5);}});});return false;},setOrderStatus:function(triggleEl,data,onSuccess,onDelSuccess){var statuslist,str=['<ul class="pop_list" style="top:0;left:0;">'];data=data||{orderid:'',status:''};if(GDT.ENV.statelist[data.status].disable){GDT.util.showMsgbox('暂无法操作，'+(triggleEl.getAttribute('title')||''));return;}
statuslist=GDT.ENV.statelist[data.status]['olist'];if(!statuslist){return;}
QZFL.object.each(GDT.helper.getStateListInfo(statuslist),function(status){str.push('<li><a href="javascript:;">'+status[1]+'</a><input type="hidden" value="'+status[0]+'" class="_val" /></li>');});str.push('</ul>');if(str.length<3){return;}
GDT.modifier.droplist(triggleEl,str.join(''),function(status){if(status==GDT.ENV.delstat){var cf=new GDT.util.Confirm('请确认：','<strong>确定要删除此广告吗？</strong>',{'icontype':'warn','type':QZFL.widget.Confirm.TYPE.OK_NO,'hastitle':false,'height':120,'desc':'删除后不可再查询数据','tips':['确认','取消']});cf.onConfirm=function(){GDT.order.del(data.orderid,function(d){if(d.ret===0){var row=QZFL.dom.getAncestorBy(triggleEl,function(n){if(n.tagName.toUpperCase()==='TR'){return true;}});if(QZFL.lang.isFunction(onDelSuccess)){onDelSuccess(status);}
row.parentNode.removeChild(row);}else{GDT.util.showMsgbox(d.msg||'删除广告失败',5);}});};cf.onNo=function(){};cf.show();return;}else{GDT.order.setStatus({orderid:data.orderid,status:status},function(d){if(d.ret===0){if(QZFL.lang.isFunction(onSuccess)){if(d.data&&d.data.status){onSuccess(d.data.status);}else{onSuccess(status);}}
GDT.util.showMsgbox('修改广告状态成功',4);}else{GDT.util.showMsgbox(d.msg||'修改广告状态失败',5);}});}});return false;},highlightRow:function(wrap){},toggleWrap:function(type,op,opts){var elm,visible,bg,idMapping={age:'_ageChart',gender:'_genderChart',area:'_areaChart'};if(((type in idMapping)&&(elm=$(idMapping[type])))||(elm=$(type))){if(op=='hide'){visible='hidden';bg='url("http://ctc.qzonestyle.gtimg.cn/open_proj/img/gdt/loading/loading32.gif") no-repeat center center';}else{visible='visible';bg='none';}
$e(elm).find('object').setStyle('visibility',visible);$e(elm).setStyle('background',bg);}},querylet:{init:function(){$e('#sdate, #edate').setAttr('title','只提供最近180天的数据');$e('#_listletWrap').removeClass('none');}},Highchartlet:function(config){this.config=jQuery.extend({wrapDom:null,chartDom:null,fieldNameMap:{},percentFields:GDT.confReport.percentFields,percentFieldsNeedMultiply100:false,allFields:[],defaultSeries:[]},config);this.wrapDom=this.config.wrapDom;this.chartDom=this.config.chartDom;this.chart=null;this.selectDisable=function(isable){var div=this.wrapDom;J(div).find('select.series-1').prop('disabled',isable);J(div).find('select.series-2').prop('disabled',isable);}
this.show=function(processedCgiObj,series,queryParams){this.selectDisable(false);this.data=processedCgiObj;this.series=series=series||this.config.defaultSeries;var fieldNameMap=this.config.fieldNameMap;GDT.log('data:',processedCgiObj,series,queryParams);this.chart=GDT.highchart.create(processedCgiObj,{target:jQuery(this.chartDom),showFileds:series,fieldNameMap:fieldNameMap,percentFields:GDT.confReport.percentFields,percentFieldsNeedMultiply100:false,title:processedCgiObj.datestr,startDate:queryParams.sdate});GDT.log('chart is',this.chart);};this.destroy=function(){(this.chart)&&(this.chart.destroy())};this.changeSeries=function(series){GDT.log('changeSeries',series,this,this.chart);this.series=series=series||this.config.defaultSeries;this.chart.showFields(series);};this.bindAction=function(){this.selectDisable(true);var allFields=this.config.allFields;var fieldNameMap=this.config.fieldNameMap;var J=jQuery,div=this.wrapDom,th=this;GDT.log('bindgin div is:',div,J(div).find('select.series-1'));J(div).find('select.series-2').html('');J(div).find('select.series-1').html('');J.each(th.config.allFields,function(k,v){J(div).find('select.series-1').append("<option value='"+v+"'>"+fieldNameMap[v]+"</option>");J(div).find('select.series-2').append("<option value='"+v+"'>"+fieldNameMap[v]+"</option>");});J(div).find('select.series-1').val(th.config.defaultSeries[0]).unbind().bind('change',function(e){th.series[0]=J(this).val();th.changeSeries(th.series);});J(div).find('select.series-2').val(th.config.defaultSeries[1]).unbind().bind('change',function(e){th.series[1]=J(this).val();th.changeSeries(th.series);});}},doExtraColumnCalculate:function(data){var d=data.list;var dl=d.length;var i;for(i=0;i<dl;i++){d[i].frontend_cpa=GDT.formater.divide(d[i].cost,d[i].tradecount,2);if(typeof d[i].viewcount==='undefined'||d[i].viewcount==='-'){d[i].frontend_cpm='-'}else{d[i].frontend_cpm=GDT.formater.divide(d[i].cost,d[i].viewcount*1000,2);}}},listlet:function(NS,config){this.NS=NS;this.config=config||{};this.wrapId=this.config.wrapId||'_list';this.listWrapId=this.config.listWrapId||'_listletWrap';this.tplId=this.config.tplId||'_tpl_list';this.noticeId=this.config.noticeId||'_notice';this.pagerId=this.config.pagerId||'_pager';this.sortByServer=this.config.sortByServer||false;this._needColumnSelect=false;this.init=function(){$e('#'+this.listWrapId).removeClass('none');$e('#'+this.pagerId).setHtml('');};this.columnButtonBind=function(){if(typeof this.config.columnConfig=='object'){this._needColumnSelect=true;}
var outerThis=this;if(this._needColumnSelect){J('#'+this.listWrapId).on('click','#_column_select_button,._column_select_button',function(e){e.preventDefault();GDT.log('_column_select_button click '+outerThis.listWrapId);outerThis.showColumnConfigDropdown(e.target);return false;});}};GDT.log('init 1 listlet '+this.listWrapId);this.columnButtonBind();this.showLoading=function(){$e('#'+this.wrapId).setHtml('');GDT.beautyUI.showLoading(this.wrapId,{minHeight:'150px'});$e('#'+this.pagerId).setHtml('');};this.bindSort=function(){var th=this;var param=this.NS._querydata;function doSort(field,order){GDT.log('>reportmodel >doSort',field,order);NS._sortField=field;NS._sortOrder=order;if(th.sortByServer){J.extend(NS._querydata,{sortfield:field,sortorder:order});NS.listlet.show(1,null,{additionalParams:{sortfield:field,sortorder:order}});}else{NS._data.list=NS.sortData(NS._data.list,field,order);NS.listlet.show(1,null,{noServerAction:true});}}
J('#'+this.wrapId+' a[by]').each(function(){var jt=J(this);jt.attr('data-hottag','atlas.report.sort_'+jt.attr('by'));});GDT.delegate(this.wrapId,'click',{asc:function(evt){var by=evt.target.getAttribute('by');doSort(by,'asc');},desc:function(evt){var by=evt.target.getAttribute('by');GDT.log('desc',by);doSort(by,'desc');}});};this.NS.sortData=function(list,field,orderby){var keys=[],result=[],sortFn;QZFL.object.each(list,function(v,k){keys.push([v[field]=='-'?-1:v[field],k]);});if(orderby=='desc'){sortFn=function(a,b){if(a[0]==b[0]){return 0;}
a[0]=GDT.formater.sortFormart(a[0]);b[0]=GDT.formater.sortFormart(b[0]);return Number(a[0])>Number(b[0])?-1:1;};}else{sortFn=function(a,b){if(a[0]==b[0]){return 0;}
a[0]=GDT.formater.sortFormart(a[0]);b[0]=GDT.formater.sortFormart(b[0]);return Number(a[0])>Number(b[0])?1:-1;};}
keys.sort(sortFn);QZFL.object.each(keys,function(v,k){result.push(list[v[1]]);});return result;};this.setSortStatus=function(){var field=NS._sortField||'',order=NS._sortOrder||'',icon,el;if(field&&order){icon=document.createElement('i');icon.className=order=='desc'?'icon ico-sort-down':'icon ico-sort-up';GDT.log('setSortStatus','#'+this.wrapId+' a[by='+field+']')
el=$e('#'+this.wrapId+' a[by='+field+']').eq(0);el.setAttribute('opt',order=='desc'?'asc':'desc');el.appendChild(icon);icon.appendChild(document.createElement('i'))}};this.NS.resetQuery=function(){NS._sortField=NS._sortOrder='';NS._querydata.page=1;NS._querydata.sortfield&&(delete NS._querydata.sortfield);NS._querydata.sortorder&&(delete NS._querydata.sortorder);};this.bindSort();this.getdata=function(page,pagesize,options){options=options||{};GDT.log('>reportmodel >getdata',page,pagesize,options);var data=this.NS._data,start,end;!pagesize&&(pagesize=20);start=pagesize*(page-1);end=start+pagesize;if(config.getAndShowData&&(!(options&&options.noServerAction))){config.getAndShowData.call(this,options.additionalParams||null);}else{this.showlistcb((data?data.list.slice(start,end):[]));}};this.show=function(page,pagesize,options){GDT.log('reportmodel------------show',page,pagesize);var params,wrap,isHours,list,data,pageconf,tpldata;GDT.beautyUI.hideLoading(this.wrapId);this.init();params=this.NS._querydata;page&&(params.page=page);pagesize&&(params.pagesize=pagesize);params.page=params.page||1;if(this.NS._data.notice){J('#'+this.noticeId).text(this.NS._data.notice);J('#'+this.noticeId).prepend('<i class="icon ico-tips"><i></i></i>');}
this.NS._data&&(list=this.NS._data.list[0])&&(list=list.statsdate||list.statstime);isHours=list&&list.indexOf(':')>0?true:false;params.isHours=isHours;if(isHours){data=this.getdata(1,100,options);}else{params.pagesize=params.pagesize||20;this.getdata(params.page,params.pagesize,options);}
if(this.NS.querylet&&this.NS.querylet.afterShow){this.NS.querylet.afterShow(params);}};this.showlistcb=function(data,params,afterFunc){GDT.log('reportmodel------------showlistcb',params,afterFunc);var N=this.NS;var tmplConfig=null;GDT.beautyUI.hideLoading(this.wrapId);if(N.querylet&&N.querylet.getTmplConfigBeforeShow){tmplConfig=N.querylet.getTmplConfigBeforeShow(data,params);GDT.log('tmplConfig:',tmplConfig,J('#_list table.mod-table').hasClass('spread'));}
var tpldata={list:data,total:this.getTotal(data),tmplConfig:tmplConfig};if(!params){params=this.NS._querydata;}
typeof params.sdate!=='undefined'&&(tpldata.sdate=params.sdate);typeof params.edate!=='undefined'&&(tpldata.edate=params.edate);typeof params.status!=='undefined'&&(tpldata.status=params.status);typeof params.appid!=='undefined'&&(tpldata.appid=params.appid);typeof params.campaignid!=='undefined'&&(tpldata.campaignid=params.campaignid);typeof params.siteset!=='undefined'&&(tpldata.siteset=params.siteset);typeof params.listname!=='undefined'&&(tpldata.listname=params.listname);tpldata.isHours=params.isHours;this.init();params=this.NS._querydata;params.page=params.page||1;params.pagesize=params.pagesize||20;var list;this.NS._data&&(list=this.NS._data.list[0])&&(list=list.statsdate||list.statstime);var isHours=list&&list.indexOf(':')>0?true:false;var wrap=$(this.wrapId);if(!wrap){GDT.log('warn: listlet wrapId not found! :',this.wrapId);return false;}
wrap.innerHTML=GDT.util.tmpl(this.tplId,tpldata);$e(wrap).hide();if(this._needColumnSelect){this.columnShowAndHide();}
$e(wrap).show();this.setSortStatus();GDT.reportModel.highlightRow(wrap);if(this.NS._data.conf){var pageconf={pagesizeChanger:true,page:params.page,pagesize:params.pagesize,totalnum:this.NS._data.conf.totalnum,totalpage:Math.ceil(this.NS._data.conf.totalnum/params.pagesize),changePagesize:typeof this.NS.changePagesize==='undefined'?true:false};GDT.log('>reportmodel >showlistcb >:',this.pagerId,pageconf);!params.isHours&&GDT.util.pager(this.pagerId,pageconf,'GDT.'+this.config.pageName+'.listlet.show');}
afterFunc&&afterFunc();};this.getTotal=function(data,format){var total={},len=data.length,percentFields={},F=GDT.formater,sumFields=GDT.confReport.sumFields,calFields=GDT.confReport.calFields,handler=GDT.confReport.calculHandler;QZFL.each(data,function(item){QZFL.each(sumFields,function(field){var val=item[field];val=val==undefined?'-':(typeof val==='string'?val.replace(/,/g,'').replace('%',''):val);if(isNaN(val)){!(field in total)&&(total[field]='-');}else{!(field in total)||isNaN(total[field])&&(total[field]=0);(field=='cost'||field=='turnover'||field=='orgcost')&&(val*=100);val=Number(val);total[field]=field in total?total[field]+val:val;}});});GDT.log('reportmodel  >getTotal :',J.extend(true,{},total));QZFL.each(calFields,function(field){if(field in handler){total[field]=handler[field].call(null,total);}});GDT.log('reportmodel  >getTotal2 :',J.extend(true,{},total));if(format!='number'){total=GDT.listdataFormater([total]).pop();}
GDT.log('reportmodel  >getTotal3 :',J.extend(true,{},total));return total;};this.getColumnConfigInfoKey=function(){var user='user_'+GDT.gOWNER;var prefix='column_config_';return user+'__'+prefix+this.config.pageName;};this.getColumnConfig=function(){var _m=this.NS;var i;var config=[];var userConfig=this.getUserColumnConfig();if(userConfig===false){var targetType=GDT.accountInfo.targettype;config=this.config.columnConfig.defaultSelect(targetType)}else{var l=userConfig.length;var ableToUse=this.config.columnConfig.ableToSelect();var ableToUseString=','+ableToUse.join(',')+',';for(i=0;i<l;i++){if(ableToUseString.indexOf(','+userConfig[i]+',')>-1){config.push(userConfig[i])}}}
return config;};this.getUserColumnConfig=function(){var key=this.getColumnConfigInfoKey();var r=QBL.storage.get(key,'local');if(r===false){return false;}else{return r.split(',');}};this.setUserColumnConfig=function(shows){var key=this.getColumnConfigInfoKey();var c=shows.join(',');QBL.storage.set(key,c,{media:'local',expire:-1});};this.columnShowAndHide=function(optionalData){var _m=this.NS;var config;if(optionalData){config=optionalData;}else{config=this.getColumnConfig();}
var ableToUse=this.config.columnConfig.ableToSelect();var configString=','+config.join(',')+',';var outerThis=this;QZFL.object.each(ableToUse,function(v){if(configString.indexOf(','+v+',')>-1){outerThis.showOneColumn(v);}else{outerThis.hideOneColumn(v);}});if(optionalData){J('#_list table').addClass('spread');}};this.showOneColumn=function(name){var prefix='col_';$e('#'+this.wrapId+' .'+prefix+name).show();};this.hideOneColumn=function(name){var prefix='col_';$e('#'+this.wrapId+' .'+prefix+name).hide();};this.showColumnConfigDropdown=function(buttonEle){var outerThis=this;var _m=this.NS;var config=this.getColumnConfig();var ableToUse=this.config.columnConfig.ableToSelect();var configString=','+config.join(',')+',';var selectListHtml='';var map=GDT.confReport.fieldsNameMapping;var checkStr='';var wraper=J(buttonEle).parent();var panel=wraper.find('div.nav-pop');if(panel.length<1){panel=J('<div class="datepop"></div>');var panelParent=J('<div class="nav-pop "></div>');panelParent.appendTo(wraper);panel.appendTo(panelParent);J('<form onsubmit="return false;" action="return false;"></form>').appendTo(J('<div class="date"></div>').appendTo(panel));J('<div class="s-btnline"></div>').html(' <a href="#" class="queding s-button-right _ok ">确定</a>'+'<a href="#" class="quxiao s-button-back _cancel">取消</a>').appendTo(panelParent);}
panel=panel.find('div.date');QZFL.object.each(ableToUse,function(v){if(configString.indexOf(','+v+',')>-1){checkStr='checked="checked"';}else{checkStr='';}
var maped='';if(map[v]){maped=map[v];}else{maped=v;}
selectListHtml+='<label><input  '+checkStr+'  name="'+v+'" class="checkbox" type="checkbox">'+maped+'</label>';});panel.find('form').html(selectListHtml);var a=new GDT.DropDownDialogHandler(buttonEle);a.onOk=function(){var data=GDT.util.getFormData(panel.find('form').get(0));GDT.log('onOk',panel.find('form').get(0),data);var toSave=[];QZFL.object.each(data,function(v,k){if(v==='yes'||v===1){toSave.push(k);}});outerThis.setUserColumnConfig(toSave);outerThis.columnShowAndHide(toSave);}};this.currentDialog=null;this.showColumnConfigDialog=function(el){var _m=this.NS;var config=this.getColumnConfig();var ableToUse=this.config.columnConfig.ableToSelect();var configString=','+config.join(',')+',';var selectListHtml='';var map=GDT.confReport.fieldsNameMapping;var checkStr='';QZFL.object.each(ableToUse,function(v){if(configString.indexOf(','+v+',')>-1){checkStr='checked="checked"';}else{checkStr='';}
var maped='';if(map[v]){maped=map[v];}else{maped=v;}
selectListHtml+='<li><input type="checkbox" '+checkStr+'  name="'+v+'" id="'+'col_sele_'+v+'" value="yes" class="input_radio _notall"><label for="'+'col_sele_'+v+'">'+maped+'</label></li>';});var htmlstr=['<div class="pop_radio_group" style="padding:25px 40px;">','<form id="_column_select">','<ul class="radio_list">','<li class="select_all"><input type="checkbox" id="col_sele_all"  name="all" class="input_radio _all"><label for="col_sele_all">全部</label></li>',selectListHtml,'</ul>','</form>','</div>'].join('\n');var outerThis=this;this.currentDialog=QZFL.dialog.create("自定义列",htmlstr,{showMask:true,width:670,height:174,buttonConfig:[{type:QZFL.dialog.BUTTON_TYPE.Cancel,text:'取消'},{type:QZFL.dialog.BUTTON_TYPE.Confirm,text:'确定',clickFn:function(){var data=GDT.util.getFormData(outerThis.currentDialog.dialogContent);delete data.all;var toSave=[];QZFL.object.each(data,function(v,k){if(v==='yes'){toSave.push(k);}});outerThis.setUserColumnConfig(toSave);outerThis.columnShowAndHide(toSave);}}],onLoad:function(dialog){var $all=$e('._all',dialog.dialogContent);var $notAll=$e('._notall',dialog.dialogContent);var allTodo=false,notAllTodo=false;$all.bind('click',function(){notAllTodo=$e(this).getAttr('checked');$notAll.setAttr('checked',notAllTodo);});$notAll.bind('click',function(){if($e(this).getAttr('checked')){if($notAll.elements.length==$notAll.filter(':checked').elements.length){allTodo=true;}else{allTodo=false;}}else{allTodo=false;}
$all.setAttr('checked',allTodo);});if($notAll.elements.length==$notAll.filter(':checked').elements.length){$all.setAttr('checked',true);}}});};return this;}};})();GDT.userChart={_querydata:{},_data:{},_datalist:{},_currentType:null,resetStatus:function(){var _m=GDT.userChart;_m._isAreaShowed=_m._isGenderShowed=_m._isAgeShowed=false;},resetData:function(){var _m=GDT.userChart;_m._datalist={};_m._data={};$e('[name=dimension][value=viewcount]').setAttr('checked',true);$e('[name=listtype][value=area]').setAttr('checked',true);},init:function(options){options=options||{};GDT.delegate(options.chartDimensionId||'_chartDimension','click',{dimension:function(evt){GDT.userChart.resetStatus();GDT.userChart.showChart(evt.target.value);}});GDT.delegate(options.listWrapId||'_listletWrap','click',{download:function(){var d=QZFL.lang.objectClone(GDT.userChart._querydata),fn;d.format='xls';delete d.listname;fn={area:'userarea',gender:'usergender',age:'useragegroup'}[GDT.userChart._currentType];fn&&(fn in GDT.cgiReport)&&GDT.cgiReport[fn](d);},listtype:function(evt){GDT.userChart.resetQuery();GDT.userChart.showList(evt.target.value);}});},getArea:function(params,onSuccess,onError){GDT.userChart._querydata=params;GDT.reportModel.toggleWrap('area','hide');GDT.cgiReport.userarea(params,function(d){var _m=GDT.userChart;if(d.ret===0){_m._datalist.area=d.data;GDT.reportModel.doExtraColumnCalculate(_m._datalist.area);if(typeof AnalysisC!=='undefined'||!d.data.list||d.data.list.length<1){_m.showList('area');}else{QBL.chart.onReady(function(){GDT.userChart.showList('area');});}
_m.showChart();GDT.reportModel.toggleWrap('area','show');QZFL.lang.isFunction(onSuccess)&&onSuccess(d.data);}else{QZFL.lang.isFunction(onError)&&onError(d);GDT.util.showMsgbox(d.msg||'获取用户地区数据失败',5);}});},getGender:function(params,onSuccess,onError){GDT.reportModel.toggleWrap('gender','hide');GDT.cgiReport.usergender(params,function(d){if(d.ret===0){GDT.userChart._datalist.gender=d.data;var _m=GDT.userChart;GDT.reportModel.doExtraColumnCalculate(_m._datalist.gender);GDT.userChart.showChart();GDT.reportModel.toggleWrap('gender','show');QZFL.lang.isFunction(onSuccess)&&onSuccess(d.data);}else{QZFL.lang.isFunction(onError)&&onError(d);GDT.util.showMsgbox(d.msg||'获取性别数据失败',5);}});},getAge:function(params,onSuccess,onError){GDT.reportModel.toggleWrap('age','hide');GDT.cgiReport.useragegroup(params,function(d){if(d.ret===0){GDT.userChart._datalist.age=d.data;var _m=GDT.userChart;GDT.reportModel.doExtraColumnCalculate(_m._datalist.age);GDT.userChart.showChart();GDT.reportModel.toggleWrap('age','show');QZFL.lang.isFunction(onSuccess)&&onSuccess(d.data);}else{QZFL.lang.isFunction(onError)&&onError(d);GDT.util.showMsgbox(d.msg||'获取年龄段数据失败',5);}});},showChart:function(field){var dataAdapter,_m=GDT.userChart,data=_m._datalist,opts={};!field&&(field='viewcount');GDT.log('>user chart> showChart> ',field,data);dataAdapter={area:function(data){var areadata={},F=GDT.formater,isPercent,total;isPercent=field=='ctr'||field=='clicktraderate';if(isPercent){total={};total[field]=0;QZFL.object.each(data.list,function(v){total[field]+=v[field];});}else{total=GDT.userChart.listlet.getTotal(data.list,'number');}
QZFL.object.each(data.list,function(v,k){var t={'count':isPercent?F.percent(v[field],2):v[field],'percent':F.divide(v[field],total[field])*1000};isPercent&&(t.hideper=true);areadata[v.areaid]=t;});QBL.chart.map('_areaChart',areadata,{width:430,height:350});},gender:function(data,opts){var t,list={};GDT.highchart.create(data,{target:J('#_genderChart').get(0),type:opts.type||'pie',fieldFormat:opts.fieldFormat||function(){},suffix:opts.suffix||'%',showFields:[field],baseField:'genderid',pieDesc:'数量',fieldNameMap:{1:'男',2:'女',0:'未知'},colorMap:{0:'#A99AB7',1:'#7996D2',2:'#F78DB3'}});},age:function(data,opts){var t,list={};GDT.highchart.create(data,{target:J('#_ageChart').get(0),type:opts.type||'pie',suffix:opts.suffix||'%',fieldFormat:opts.fieldFormat||function(){},showFields:[field],baseField:'agegroupid',pieDesc:'数量',fieldNameMap:{0:'未知',1:'18岁以下',2:'18-23岁',4:'24-30岁',8:'31-40岁',16:'41-50岁',32:'50岁以上'},colorMap:{'1':'#fae49b','2':'#a0dca0','4':'#90d4e7','8':'#7996d2','16':'#feadac','32':'#f78db3','0':'#a196b6'}});}};var _isctr=(field=='ctr'||field=='clicktraderate');if('area'in data){_m._isAreaShowed=true;_m.checkData(data.area,'area',field)&&dataAdapter.area(data.area);}
if('gender'in data){_m._isGenderShowed=true;if(_isctr){opts.type='column';opts.suffix='%';opts.fieldFormat=function(v){return v*100;}}
_m.checkData(data.gender,'gender',field)&&dataAdapter.gender(data.gender,opts);}
if('age'in data){_m._isAgeShowed=true;if(_isctr){opts.type='column';opts.suffix='%';opts.fieldFormat=function(v){return v*100;}}
_m.checkData(data.age,'age',field)&&dataAdapter.age(data.age,opts);}},checkData:function(data,type,field){var result=false,eid,msg;eid={area:'_areaChart',gender:'_genderChart',age:'_ageChart'}[type];if(data.list.length>0){result=true;}else{var margintop=J('#'+eid).height()/2.0-13;msg='<div class="nodata" style="margin-top:'+margintop+'px"><i class="icon-warning-gray22"><i></i></i>暂无数据</div>';}
msg&&J('#'+eid).html(msg);return result;},showList:function(type){var data,namemap,titlemap,tpldata,list,isDataInvalid=true;_m=GDT.userChart;!type&&(type='area');data=_m._datalist[type]||{};_m._currentType=type;for(var x in data){if(data[x]){isDataInvalid=false;break}}
if(isDataInvalid){return;}
list=QZFL.lang.objectClone(data.list);titlemap={area:'地区',gender:'性别',age:'年龄'};data.listname=titlemap[type];namemap={area:function(d){return AnalysisC.mapArea[d.areaid]||'未定义('+d.areaid+')';},gender:function(d){return['未知','男','女'][d.genderid]||'未定义('+d.genderid+')';},age:function(d){return{0:'未知',1:'18岁以下',2:'18-23岁',4:'24-30岁',8:'31-40岁',16:'41-50岁',32:'50岁以上'}[d.agegroupid]||'未定义('+d.agegroupid+')';}};QZFL.object.each(list,function(v,k){v.name=namemap[type](v);});_m._querydata.listname=data.listname;list=GDT.listdataFormater(list);if(type=='gender'){list=_m.sortData(list,'genderid','desc');}else if(type=='age'){list=_m.sortData(list,'agegroupid','asc');}
_m._data={list:list};_m.listlet.show();}};
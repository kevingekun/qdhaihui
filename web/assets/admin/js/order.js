
(function(){GDT.BaseField=function(type,name,opts){opts=opts||{};this.type=type;this.name=name;this.config=opts;this._valkeys=null;this.tplItem='';this.tplList='';this.tplWrap='';typeof opts.value!=='undefined'&&(this.value=opts.value);this.bind('/field/init',function(){var name=this.name;J('#'+name).bind('change',function(){GDT.modOrder.validate(name);});});this.bind('/field/change',function(evt,value,orivalue){this.value=value;if(orivalue!==value){opts.onchange&&opts.onchange.call(this,evt,value,orivalue);value&&orivalue!=value&&this.trigger('/field/validate',value);};});return this;};GDT.BaseField.prototype.setAttr=function(attr,field){var attrs={};if(arguments.length>1){attrs[arguments[0]]=arguments[1];}else if(typeof attr==='object'){attrs=attr;}
for(var x in attrs){if(x==='config'){J.extend(true,this.config,attrs.config);if('counter'in attrs.config){J('#'+this.name+'MaxLength').html(attrs.config.counter[1]);}}else if(x==='delegate'){GDT.modOrder.delegateEvent.add(this.name,attrs[x]);}else if(typeof attrs[x]!=='function'||x!=='items'){this[x]=attrs[x];}}
if(!this._valkeys){this._valkeys=[this.name];}};GDT.BaseField.prototype.genHtml=function(){var cont,type=this.type,items,value=this.value,name=this.name,tplList=this.tplList,tplWrap=this.tplWrap,wrapid=this.wrapid||'',notiteritems=this.notiteritems,disabledstr='',_me=this;if(this.forbidden){return'';}
items=(!this.items||notiteritems)?(type=='select'?[['加载中……','']]:[['','']]):this.items;J.isArray(name)&&(name=name.join(GDT.ENV.SELECTOR_KEY_KEY));name=name.replace(/\{ITEMVALUE\}/g,name);type=='select'&&(tplList='<span class="prompt">'+tplList+'</span>');tplList=(function(){var tpltmp=[],isWrapped,isPWrapper;isWrapped=tplList&&(new RegExp('(\{NAME\}|'+name+')ItemsWrap').test(tplList));isPWrapper=/<p[^>]*>/.test(tplWrap)?true:false;tpltmp.push('{TPL_LIST_PREFIX}');!isWrapped&&tpltmp.push(isPWrapper?'<span id="{NAME}ItemsWrap">':'<div id="{NAME}ItemsWrap" style="display:inline">');tpltmp.push(tplList||'{TPL_ITEMS}');!isWrapped&&tpltmp.push(isPWrapper?'<span id="{NAME}ItemsWrap">':'</div>');tpltmp.push('{TPL_LIST_SUFFIX}');return tpltmp.join('');})();cont=this.genItems(items);disabledstr=this.editable===false?'disabled="disabled"':'';cont=tplList.replace(/\{NAME\}/g,name).replace(/\{TPL_ITEMS\}/g,cont).replace(/\{PLACEHOLDER\}/g,this.placeholder||'').replace(/\{HEIGHT\}/g,this.height?this.height+'px':'').replace(/\{TPL_LIST_PREFIX\}/,this.tplListPrefix||'').replace(/\{TPL_LIST_SUFFIX\}/,this.tplListSuffix||'').replace(/\{DISABLED\}/g,disabledstr);tplWrap&&(cont=tplWrap.replace(/\{TPL_LIST\}/g,cont).replace(/\{ID\}/,wrapid));return cont;};GDT.BaseField.prototype.genItems=function(items,checkedValue){var cont=[],_me=this,dict,tplItem=this.tplItem||'';typeof checkedValue==='undefined'&&(checkedValue=this.value);dict={};!J.isArray(items)&&(items=[['',items]]);J.each(items||[],function(i,item){var classname=_me.classname||'',itemstr='',checkstr='',disabledstr='',label=item[0],value=item[1],disabled,disabledTip,helpIcon;!item[2]&&(item[2]='');disabled=item[2]===true||item[2].disabled;disabledTip=item[3]||item[2].disabledTip||'';checkstr=value&&value==checkedValue?(_me.type==='select'?'selected="selected"':'checked="checked"'):'';disabledstr=_me.editable===false||disabled?'disabled="disabled"'+(disabledTip?' title="'+disabledTip+'"':''):'';dict[value]=label;if(J.isPlainObject(item[2])){helpIcon=item[2].helpIcon||'';helpIcon&&(label+='<i class="icon ico-help" rel="'+helpIcon+'"><i></i></i>');};itemstr=tplItem.replace(/(<input.*?>)/g,'<span class="prompt">$1</span>').replace(/(<textarea.*?>)/g,'<span class="prompt">$1').replace(/(<\/textarea>)/g,'$1</span>').replace(/\{NAME\}/g,_me.name).replace(/\{CLASS\}/g,classname).replace(/\{INDEX\}/g,i).replace(/\{CHECKED\}/g,checkstr).replace(/\{DISABLED\}/g,disabledstr).replace(/\{ITEMLABEL\}/g,label).replace(/\{ITEMVALUE\}/g,value);if(J.isPlainObject(item[2])){J.each(item[2],function(key,val){if(key.substring(0,1)!=='{'){return;}
key=key.replace('{','\{').replace('}','\}');itemstr=itemstr.replace((new RegExp(key,'g')),val);});}
cont.push(itemstr);});GDT.translator.setDict(this.name,dict);return cont.join('');};GDT.BaseField.prototype.getValue=function(){var val=GDT.form.getFieldData(this.name);return val;};GDT.BaseField.prototype.setValue=function(value){var orivalue=this.getValue(),params;this.value=value;if(typeof value==='object'){params=value;}else{params={};params[this.name]=this.value;}
GDT.form.setFieldsData([this.name],params);if(this.value!=orivalue){this.trigger('/field/change',[this.value,orivalue]);if(this.config.counter){J('#'+this.name).trigger('change');}}};GDT.BaseField.prototype.setItems=function(items,checkedValue){var cont,wrap,elId;typeof checkedValue==='undefined'&&(checkedValue=this.value);cont=this.genItems(items,checkedValue);elId=this.name+(this.type=='select'?'':'ItemsWrap');if(wrap=$(elId)){J(wrap).html(cont);}else{this.bind('/field/init',(function(name,cont,elId){return function(){J('#'+elId).html(cont);};})(name,cont,elId));}};GDT.BaseField.prototype.hide=function(){var elId=this.name+(this.type=='select'?'':'ItemsWrap');J($(elId)).parents('._blockcontent:first').hide();};GDT.BaseField.prototype.show=function(){var elId=this.name+(this.type=='select'?'':'ItemsWrap');J($(elId)).parents('._blockcontent:first').show();};GDT.BaseField.prototype.validate=function(){return true;};GDT.BaseField.prototype.setValkeys=function(farr){this._valkeys=farr;};J.extend(GDT.BaseField.prototype,GDT.event);})();(function(){GDT.RadioField=function(name,items,opts){var instance=new GDT.BaseField('raido',name,opts),attrs,defaultTemplate;defaultTemplate='<label class="{CLASS}"><input type="radio" class="radio {CLASS}" id="{NAME}{INDEX}" name="{NAME}" value="{ITEMVALUE}" opt="{NAME}{ITEMVALUE}" {DISABLED} {CHECKED}>{ITEMLABEL}</label>';opts=opts||{};attrs={name:name,items:items,classname:(opts.classname||'mg-r35'),tplItem:(opts.tplItem||defaultTemplate)};opts.tplList&&(attrs.tplList=opts.tplList);opts.tplWrap&&(attrs.tplWrap=opts.tplWrap);instance.setAttr(attrs);instance.bind('/field/init',function(){var eles=J('[name='+instance.name+']');eles.eq(0).prop('checked',true);eles.bind('click',function(evt){instance.trigger('/field/change',this.value);J.publish('/field/change',instance.name);});});return instance;};GDT.CheckboxField=function(name,items,opts){var instance=new GDT.BaseField('checkbox',name,opts),attrs,tplNameSuffix='',defaultTemplate;opts=opts||{};defaultTemplate='<label class="{CLASS}"><input type="checkbox" class="checkbox {CLASS}" id="{NAME}{INDEX}" name="{NAME}'+tplNameSuffix+'" value="{ITEMVALUE}" opt="{NAME}{ITEMVALUE}" {CHECKED} {DISABLED}>{ITEMLABEL}</label>';attrs={name:name,items:items,classname:(opts.classname||'mg-r35'),getValue:function(){var val;val=GDT.form.getValue(name+tplNameSuffix);return val;},setValue:function(data){data=J.isPlainObject(data)&&(name in data)?data[name]:data;GDT.form.setValue(name+tplNameSuffix,data);},tplItem:opts.tplItem?opts.tplItem:defaultTemplate};instance.setAttr(attrs);instance.bind('/field/init',function(){J('[name='+instance.name+']').bind('click',function(evt){instance.trigger('/field/change');J.publish('/field/change',instance.name);});});return instance;};GDT.TextField=function(name,items,opts){var instance=new GDT.BaseField('text',name,opts),attrs,defaultTemplate;defaultTemplate='<input type="text" id="{NAME}" class="{CLASS}" name="{NAME}" value="{ITEMVALUE}" {DISABLED} placeholder="{PLACEHOLDER}">';opts=opts||{};attrs={name:name,classname:opts.classname||'text input-txt mg-r10',items:items,tplItem:opts.tplItem?opts.tplItem:defaultTemplate};if(opts.counter){var realtimeCheck=function(){GDT.modOrder.realtimeTxtCounter(name,{min:opts.counter[0],max:opts.counter[1],getMinMaxConfig:(function(instance){return function(){return{min:instance.config.counter[0],max:instance.config.counter[1]};};})(this),onInput:opts.oninput||function(){},onError:(function(name,label){return function(){GDT.modOrder.showError(name,'请输入正确的'+label);};})(name,instance.label),onSuccess:(function(name){return function(){GDT.modOrder.hideError(name);};})(name)});};instance.bind('/field/change',realtimeCheck).bind('/field/init',realtimeCheck);}
instance.setAttr(attrs);return instance;};GDT.TextareaField=function(name,items,opts){var instance=new GDT.BaseField('textarea',name,opts),attrs,defaultTemplate;defaultTemplate='<textarea id="{NAME}" class="{CLASS}" name="{NAME}" {DISABLED} placeholder="{PLACEHOLDER}" style="{HEIGHT}">{ITEMVALUE}</textarea>';opts=opts||{};attrs={name:name,classname:opts.classname||'text-area mg-r10',items:items,tplItem:opts.tplItem?opts.tplItem:defaultTemplate};if(opts.counter){var realtimeCheck=function(){GDT.modOrder.realtimeTxtCounter(this.name,{min:opts.counter[0],max:opts.counter[1],getMinMaxConfig:(function(instance){return function(){return{min:instance.config.counter[0],max:instance.config.counter[1]};};})(this),onError:(function(name,label){return function(){GDT.modOrder.showError(name,'请输入正确的'+label);}})(name,instance.label),onSuccess:(function(name){return function(){GDT.modOrder.hideError(name);}})(name)});};instance.bind('/field/change',realtimeCheck).bind('/field/init',realtimeCheck);}
instance.setAttr(attrs);return instance;};GDT.LabelField=function(name,items,opts){var instance=new GDT.BaseField('label',name,opts),attrs,rt;opts=opts||{};attrs={name:name,items:items,tplItem:opts.tplItem?opts.tplItem:'<p>{ITEMVALUE}</p>'};if(typeof opts.items==='function'){rt=opts.items.call(instance);typeof rt==='string'&&(attrs.items=rt);}
instance.setAttr(attrs);return instance;};GDT.SelectField=function(name,items,opts){var instance=new GDT.BaseField('select',name,opts),attrs;opts=opts||{};attrs={name:name,items:items,tplItem:opts.tplItem?opts.tplItem:'<option value="{ITEMVALUE}" {CHECKED}>{ITEMLABEL}</option>',tplList:'<select id="{NAME}" name="{NAME}" {DISABLED}>{TPL_ITEMS}</select>'};instance.setAttr(attrs);return instance;};GDT.FileField=function(name,items,opts){var instance=new GDT.BaseField('file',name,opts),attrs;opts=opts||{};attrs={name:name,tplItem:opts.tplItem?opts.tplItem:'<p class="mg-b10"><input type="file" class="input_file" id="{NAME}{INDEX}" name="{NAME}" data-file="{ITEMVALUE}" {DISABLED}></p>'};instance.setAttr(attrs);return instance;};GDT.CalendarFiled=function(name,items,opts){var instance=new GDT.BaseField('text',name,opts),attrs,tpl,tplItem=[],value=opts.value||[];opts=opts||{};!J.isArray(name)&&(name=[name]);!J.isArray(value)&&(value=[value]);tpl=opts.tplItem||'<input type="text" id="{NAME}" class="text text-date" name="{NAME}" value="{VALUE}">';J.each(name,function(i,n){tplItem.push(tpl.replace(/{NAME}/g,n).replace(/{VALUE}/g,value[i]));});tplItem=tplItem.join(' 至 ');attrs={name:name.join(GDT.ENV.SELECTOR_KEY_KEY),tplItem:tplItem,getValue:function(){var val=[],name,_me=this;name=J.isArray(this.name)?this.name:name.split(GDT.ENV.SELECTOR_KEY_KEY);J.each(name,function(i,field){var v=GDT.form.getFieldData(field);val.push(v);});return val;},setValue:function(values){var orivalue=this.getValue(),name;this.value=values;name=J.isArray(this.name)?this.name:name.split(GDT.ENV.SELECTOR_KEY_KEY);J.each(name,function(i,field){QBL.calendar.setDate(field,values[i]||'');});this.trigger('/field/change',[this.value,orivalue]);}};instance.setAttr(attrs);instance.bind('/field/init',function(){J.each(name,function(i,n){QBL.calendar.init(n,function(d){GDT.modOrder.trigger(n,'/field/change',[J.timeFormatString(d.getTime(),'{Y}-{M}-{d}')]);});});});return instance;};GDT.MultiselectField=function(name,items,opts){var instance=new GDT.BaseField('multiselect',name,opts),attrs;opts=opts||{};attrs={name:name,items:items,tplItem:opts.tplItem?opts.tplItem:''};instance.setAttr(attrs);return instance;};GDT.AsyncField=function(name,items,opts){var instance=new GDT.BaseField('asyncfield',name,opts),attrs;opts=opts||{};attrs={name:name,items:items,isinited:false,setValbeforeinit:false,_getData:function(fn){var data;if(!this.isinited){data=this.value;}else{data=this.value=fn();}
return data;},_storeData:function(data,fn){var da={};if(!this.isinited){this.setValbeforeinit=true;J.each(this._valkeys,function(k,v){da[v]=data[v];});this.value=da;}else{fn&&fn(data);}},tplItem:opts.tplItem?opts.tplItem:''};instance.bind('ready',function(){instance.isinited=true;if(instance.setValbeforeinit){instance.setValue(instance.value);}});instance.setAttr(attrs);return instance;};GDT.AssoCheckBoxField=function(name,items,opts){var instance=new GDT.BaseField('assocheckbox',name,opts),attrs,enbinstance,enbopts={},chkinstance,chkopts={};opts=opts||{};enbopts.tplWrap=opts.enableWrap;enbopts.editable=typeof opts.editable!=='undefined'?opts.editable:true;chkopts.editable=typeof opts.editable!=='undefined'?opts.editable:true;chkopts.tplWrap=opts.chkwraper;chkopts.wrapid=opts.chkwraperid;enbinstance=new GDT.Field(opts.enableField,'radio',opts.enableItems,enbopts);chkinstance=new GDT.Field(opts.name,'checkbox',opts.items,chkopts);attrs={name:name,notiteritems:true,enbinstance:enbinstance,chkinstance:chkinstance,getValue:function(){var enbval,chkval,data={};enbval=this.enbinstance.getValue();data[enbinstance.name]=enbval;chkval=this.chkinstance.getValue();data[chkinstance.name]=chkval;return data;},setValue:function(data){var val=J.isPlainObject(data)?data[this.name]:data,enbdata={},enb=0;if(this.empty&&!this.empty(val)){enb=1;chkinstance.setValue(data);}
enbinstance.setValue(enb);GDT.form.fireFieldAsso(opts.enableField);},tplItem:enbinstance.genHtml()+chkinstance.genHtml()};instance.setAttr(attrs);instance.bind('/field/init',function(){enbinstance.trigger('/field/init');enbinstance.bind('/field/change',function(){instance.trigger('/field/change');J.publish('/field/change',instance.name);});chkinstance.trigger('/field/init');chkinstance.bind('/field/change',function(){instance.trigger('/field/change');J.publish('/field/change',instance.name);});GDT.form.setFieldAsso(opts.enableField,['1'],'',function(ret){var wrap=J('#'+opts.chkwraperid);if(ret){wrap.show(400);}else{wrap.slideUp(400);}});});return instance;};})();(function(){var typeMap={radio:'RadioField',checkbox:'CheckboxField',text:'TextField',textarea:'TextareaField',label:'LabelField',select:'SelectField',file:'FileField',calendar:'CalendarFiled',multiselect:'MultiselectField',assocheckbox:'AssoCheckBoxField'};GDT.addFieldType=function(type,instancename){typeMap[type]=instancename;};GDT.Field=function(name,type,items,opts){var instance,fieldClass;if(!(type in typeMap)&&!GDT[type+'Field']){throw'unsupported filed type "'+type+'", name='+name+'.';}
fieldClass=typeMap[type];instance=new GDT[fieldClass](name,items,opts);if(typeof opts==='object'){instance.setAttr(opts);}
return instance;};})();(function(){GDT.OrderlinkField=function(name,items,opts){var instance=new GDT.BaseField('orderlink',name,opts),attrs;var tpl=['<p class="mg-b10">','<label><input type="radio" class="radio" id="_linktype_1" name="linktype"value="1" />普通链接</label>','<input type="text"  id="orderlink" name="orderlink" class="text mg-l15 input-url"/>','</p>','<p class="mg-b10" id="_merchantqq">','<label><input type="radio" class="radio" id="_linktype_2" name="linktype" value="2"/>商户QQ</label>','<input type="text" id="linktarget_merchantqq" name="linktarget_merchantqq" value="10000" class="text mg-l15 input-url"/>','</p>','<p class="mg-b10">','<label><input type="radio" class="radio" name=""/>营销QQ</label>','<input type="text" name="" class="text mg-l15 input-url"/>','</p>','<p class="mg-b10">','<label><input type="radio" class="radio" name=""/>认证空间</label>','<input type="text" name="" class="text mg-l15 input-url"/>','</p>'].join('');opts=opts||{};attrs={name:name,items:items,getValue:function(){},setValue:function(data){},template:tpl};instance.setAttr(attrs);return instance;};GDT.addFieldType('orderlink','OrderlinkField');GDT.CDateField=function(name,items,opts){var instance=new GDT.BaseField('orderlink',name,opts),attrs,_innerFields=['sdate','edate'];var tpl=['<div class="">','<input type="text" id="sdate" class="text  text-date" value="">','至 ','<input type="text" id="edate" class="text text-date" value="">','</div>'].join('');opts=opts||{};attrs={name:name,items:items,getValue:function(){return GDT.form.getFieldsData(_innerFields);},setValue:function(data){GDT.form.setFieldValue(_innerFields,data);},template:tpl};instance.setAttr(attrs);instance.bind('/field/init',function(){var now=GDT.util.getTime(),_me=this,daynum=this.daynum||3;var onSelected=function(d){var ndate=J.timeFormatString(GDT.util.getTime(),'{Y}-{M}-{d}'),sdate=$('sdate').value;_me.trigger('/field/change');};QBL.calendar.init('sdate',onSelected,{value:now});QBL.calendar.init('edate',onSelected,{value:now+daynum*3600000*24});});return instance;};GDT.addFieldType('cdate','CDateField');GDT.TimesetField=function(name,items,opts){var instance=new GDT.BaseField('timeset',name,opts),attrs;var tpl=['<p class="">','<label><input type="radio" class="radio"name="timetype" value="1"  id="alltime" checked="checked" />全时间段</label>','<label><input type="radio" class="radio mg-l35" name="timetype" value="0" />特定时间段</label>','<span id="timeSelEasy" class="_js_timeswitch">','<select class="form_select" id="timeSelStart"></select><','span class="to_date">-</span>','<select class="form_select" id="timeSelEnd"></select>','</span>','<a id="timeSelSwitch" href="javascript:;" onclick="return false" class="mg-l35 _js_timeswitch">返回快速选择模式</a>','</p>','<span id="timeSelAdv" class="_js_timeswitch">','<div class="put-time-tips">','<p>单击方格【可选中/取消时间点】&nbsp;&nbsp;单击拖动方格【可选中/取消某一连续时间段】</p>','<ul>','<li><span class="bgcol-c"></span>选中态</li><li><span class="bgcol-b"></span>点击态</li>','<li><span class="bgcol-a"></span>未选中</li>','</ul>','</div>','<div class="time-choose"  id="timeflash" style="width: 725px;">','</div>','<div class="time-show">','<p class="detail-item">已选时间：</p>','<ol id="time_seled">','</ol>','<input type="hidden" id="time" name="timeset" value="" />','<a href="javascript:;" onclick="return false" class="ButtonBg5 revoke" id="clearTimeSelect">撤销所有选择</a>','</div>','</span>'].join('');opts=opts||{};attrs={name:name,items:items,getValue:function(){return{timeset:GDT.timemod.getTimeData()};},setValue:function(data){var dt=data.timeset;GDT.timemod.setTimeData(dt);},template:tpl};instance.setAttr(attrs);instance.bind('/field/init',function(){GDT.timemod.initTimeMod();});return instance;};GDT.addFieldType('timeset','TimesetField');})();(function(MOrder){MOrder._timerCache={};MOrder._domCache={};MOrder.fieldInstance={};MOrder.getInstance=function(fieldname){J.isArray(fieldname)&&(fieldname=fieldname.join(GDT.ENV.SELECTOR_KEY_KEY));return MOrder.fieldInstance[fieldname];};MOrder.dance=function(fieldname){J.isArray(fieldname)&&(fieldname=fieldname.join(GDT.ENV.SELECTOR_KEY_KEY));MOrder.fieldInstance[fieldname]&&MOrder.fieldInstance[fieldname].interaction&&MOrder.fieldInstance[fieldname].interaction.call(MOrder.fieldInstance[fieldname]);};MOrder.clearInstance=function(fieldname){J.isArray(fieldname)&&(fieldname=fieldname.join(GDT.ENV.SELECTOR_KEY_KEY));delete MOrder.fieldInstance[fieldname];};MOrder.delegateEvent={list:{},add:function(field,eventlist){for(var x in eventlist){this.list[field+x]=eventlist[x];}},trigger:function(field,evtkey,evttype,evttarget,triggedCallback){this.list[field+evtkey].call(evttarget,{type:evttype,event:null,target:evttarget},triggedCallback);}};MOrder.instanceToInit=[];MOrder.getValue=function(fields,onlyNeedField){var single=false,data={};typeof fields!=='object'&&(data='',single=true,fields=[fields]);J.each(fields,function(k,field){var fielddata,instance;instance=MOrder.getInstance(field);if(!instance){return;}
fielddata=instance.getValue();if(single){data=fielddata;return false;}else{if(J.isPlainObject(fielddata)){J.extend(data,fielddata);}else if(J.isArray(fielddata)){var name=instance.name;typeof name==='string'&&(name=name.split(GDT.ENV.SELECTOR_KEY_KEY));J.each(fielddata,function(i,val){data[name[i]]=val;})}else{data[field]=fielddata;}}});if(single&&onlyNeedField&&J.isPlainObject(data)){data=data[onlyNeedField];}
return data;};MOrder.setValue=function(fields,fieldsData){typeof fields==='string'&&(fields=[fields]);J.each(fields,function(k,field){var instance;instance=MOrder.getInstance(field);if(!instance){return;}
instance.setValue(fieldsData);});};MOrder.setDisable=function(fields){typeof fields==='string'&&(fields=[fields]);J.each(fields,function(k,field){var instance;instance=MOrder.getInstance(field);if(!instance){return;}
J('#'+instance.name+'ItemsWrap [name^="'+instance.name+'"]').prop('disabled',true);J('#enable_'+instance.name+'ItemsWrap [name^="enable_'+instance.name+'"]').prop('disabled',true);});};MOrder.setEnable=function(fields){typeof fields==='string'&&(fields=[fields]);J.each(fields,function(k,field){var instance;instance=MOrder.getInstance(field);if(!instance){return;}
J('#'+instance.name+'ItemsWrap [name^="'+instance.name+'"]').prop('disabled',false);J('#enable_'+instance.name+'ItemsWrap [name^="enable_'+instance.name+'"]').prop('disabled',false);});};MOrder.setAttr=function(field,attrs){var instance;instance=MOrder.getInstance(field);if(!instance){return;}
instance.setAttr(attrs);}
MOrder.setItems=function(field,items,checkedValue){var instance,orivalue;instance=MOrder.getInstance(field);if(!instance){return;}
instance.setItems(items,checkedValue);if(checkedValue||checkedValue===0){orivalue=MOrder.getValue(field);if(J.isPlainObject(orivalue)){orivalue=field in orivalue?orivalue[field]:'';};instance.trigger('/field/change',[checkedValue,orivalue]);};};MOrder.refreshItems=function(fields){!J.isArray(fields)&&(fields=[fields]);J.each(fields,function(i,field){var instance;instance=MOrder.getInstance(field);if(instance&&typeof instance.config.items==='function'){instance.config.items.call(instance);}});};MOrder.encodeName=function(name,suffix){var parts=[name];suffix&&parts.push(suffix);return name.indexOf(GDT.ENV.SELECTOR_KEY_VAL)>-1?name:parts.join(GDT.ENV.SELECTOR_KEY_VAL);};MOrder.decodeName=function(name){var parts=name.split(GDT.ENV.SELECTOR_KEY_VAL);return parts.shift();};MOrder.resetItems=function(fields){!J.isArray(fields)&&(fields=[fields]);J.each(fields,function(i,field){var instance=MOrder.getInstance(field);J('#'+instance.name+'ItemsWrap').parent().parent().replaceWith(J(MOrder.renderSlot(instance.config,instance.config.tplSlot)));if(instance&&typeof instance.config.items==='function'){instance.config.items.call(instance);}
if(instance.counter){var realtimeCheck=function(){GDT.modOrder.realtimeTxtCounter(name,{min:instance.counter[0],max:instance.counter[1],getMinMaxConfig:(function(instance){return function(){return{min:instance.config.counter[0],max:instance.config.counter[1]};};})(this),onInput:opts.oninput||function(){},onError:(function(name,label){return function(){GDT.modOrder.showError(name,'请输入正确的'+label);}})(name,instance.label),onSuccess:(function(name){return function(){GDT.modOrder.hideError(name);}})(name)});};instance.bind('/field/change',realtimeCheck).bind('/field/init',realtimeCheck);}
instance.oninit&&instance.bind('/field/init',instance.oninit);instance.trigger('/field/init');MOrder.bindDefaultEvent(instance.name);MOrder.delOrderCacheData(instance.name);});};MOrder.trigger=function(field,event,args){var instance;instance=MOrder.getInstance(field);if(!instance){return;}
instance.trigger(event,args);};MOrder.validate=function(fields){var result=true;!J.isArray(fields)&&(fields=[fields]);J.each(fields,function(i,field){var instance=MOrder.getInstance(field),value,msg,txtLimit,rt=true;if(!instance){return;}
value=instance.getValue();if(instance.require){if(value===''){msg='请'+(instance.type==='text'?'正确输入':'选择')+instance.label;rt=false;}
if(rt&&(txtLimit=instance.counter)){var len=value.length;if(len<txtLimit[0]){msg=instance.label+'内容太少';rt=false;}else if(len>txtLimit[1]){msg=instance.label+'内容太多';rt=false;}}}
if(rt){rt=instance.validate(value);if(J.isPlainObject(rt)){msg=rt.msg;rt=rt.type=='warning'?true:false;}else if(typeof rt==='string'){msg=rt;rt=false;}}
if(rt===false){result=false;MOrder.addInvalidFields(field);msg&&MOrder.showError(field,msg);}else{MOrder.clearInvalidFields(field);if(msg){MOrder.showError(field,msg);}else{MOrder.hideError(field);}}});return result;};MOrder.hide=function(fields){!J.isArray(fields)&&(fields=[fields]);J.each(fields,function(i,field){var instance=MOrder.getInstance(field);if(instance){instance.hide();}});};MOrder.show=function(fields){!J.isArray(fields)&&(fields=[fields]);J.each(fields,function(i,field){var instance=MOrder.getInstance(field);if(instance){instance.show();}});};MOrder.invalidFileds={length:0};MOrder.addInvalidFields=function(fields){if(fields){!J.isArray(fields)&&(fields=[fields]);J.each(fields,function(i,field){!(field in MOrder.invalidFileds)&&(MOrder.invalidFileds.length++);MOrder.invalidFileds[field]=true;});}};MOrder.clearInvalidFields=function(fields){if(fields){!J.isArray(fields)&&(fields=[fields]);J.each(fields,function(i,field){if(MOrder.invalidFileds[field]){delete MOrder.invalidFileds[field];MOrder.invalidFileds.length--;}});}else{MOrder.invalidFileds={length:0};}};MOrder.showError=function(field,msg,opts){var wrap,ipt,top,left,bounds;if(!msg){return;};opts=opts||{};MOrder.hideError(field);wrap=J('#'+field+'ItemsWrap').find('.prompt:last').eq(0);if(('top'in opts)&&('left'in opts)){wrap.append('<span class="tips-normal _errtips" style="top:'+opts.top+'px;left:'+opts.left+'px"><i class="icon ico-warning"><i></i></i>'+msg+'</span>');}else{wrap.length&&(ipt=J('[type=file],[type=hidden]',wrap).get(0));!ipt&&field&&(field=field.split(GDT.ENV.SELECTOR_KEY_KEY).shift(),ipt=J('[name='+field+']').get(0),!ipt&&(ipt=J('[name=enable_'+field+']').get(0)),wrap=J(ipt).parents('.prompt').eq(0));if(wrap.length===0){ipt=J('[name=enable_'+field+']').get(0);wrap=J(ipt).parents('.prompt').eq(0)}
if(ipt){bounds=ipt.getBoundingClientRect();top=typeof opts.top!=='undefined'?opts.top:Math.max(bounds.height||J(ipt).outerHeight()||J(ipt).height(),22);left=typeof opts.left!=='undefined'?opts.left:parseInt(J(ipt).css('marginLeft'),10)||0;wrap.append('<span class="tips-normal _errtips" style="top:'+top+'px;left:'+left+'px"><i class="icon ico-warning"><i></i></i>'+msg+'</span>');}else{GDT.log('Can not find the fields('+field+') to show Error('+msg+')');}}};MOrder.hideError=function(fields){!J.isArray(fields)&&(fields=[fields]);J.each(fields,function(i,field){if(!!field&&!!field.replace){field=field.replace('+','\\+');J('#'+field+'ItemsWrap ._errtips').remove();J('#'+field).parents('.prompt').find('._errtips').remove();}});};MOrder.render=function(wrap,fieldsConfig,template){var cont;MOrder.instanceToInit=[];cont=MOrder.renderPagelet(fieldsConfig,template);typeof wrap==='string'&&(wrap=$(wrap));wrap.innerHTML=cont;wrap.style.display=wrap.parentNode.style.display='';MOrder.delegateEvent.add('_block',{expand:function(event){var attrval,attrkey='data-status',dftval='expand',expandval='expand',collapseval='collapse',expandtip='点击展开',collapsetip='点击收起',thisEl=J(event.target),blockContent,blockIndex=thisEl.closest('._block').index(),handlerEl;blockContent=MOrder._domCache['_blockexpand'+blockIndex];if(!blockContent){blockContent=thisEl.closest('._block').find('._blockcontent:visible');MOrder._domCache['_blockexpand'+blockIndex]=blockContent;}
handlerEl=thisEl.hasClass('_blocktitle')?thisEl:thisEl.closest('._blocktitle');attrval=handlerEl.attr(attrkey)||dftval;if(attrval==expandval){handlerEl.attr(attrkey,collapseval).attr('title',expandtip).find('.hide').removeClass('hide').addClass('open');blockContent.slideUp('swing');}else{handlerEl.attr(attrkey,expandval).attr('title',collapsetip).find('.open').removeClass('open').addClass('hide');blockContent.slideDown('swing');}}});QBL.delegate(wrap,'click',MOrder.delegateEvent.list,{preevent:function(){}});J.each(MOrder.instanceToInit,function(i,instance){instance.oninit&&instance.bind('/field/init',instance.oninit);instance.trigger('/field/init');MOrder.bindDefaultEvent(instance.name);});};MOrder.bindDefaultEvent=function(field,evetMapping){var instance=MOrder.getInstance(field),fieldTypeHandler,evts;fieldTypeHandler={text:function(){if(typeof this.onchange!=='function'){return};J('input[type=text],input[name^='+this.name+']',J('#'+this.name+'ItemsWrap')).bind('blur',(function(_m){return function(){_m.config.onchange.call(_m,this.value);MOrder.trigger(_m.name,'/field/validate',[this.value]);};})(this));},select:function(){if(typeof this.config.onchange!=='function'){return};J('select[name^='+this.name+']').bind('change',(function(_m){return function(){_m.value=this.value;_m.config.onchange.call(_m,this.value);MOrder.trigger(_m.name,'/field/validate',[this.value]);};})(this));},file:function(){if(typeof this.config.onchange!=='function'){return};J('input[type=file],input[name^='+this.name+']',J('#'+this.name+'ItemsWrap')).bind('change',(function(_m){return function(){_m.config.onchange.call(_m,this.value);MOrder.trigger(_m.name,'/field/validate',[this.value]);};})(this));}};evetMapping=evetMapping||{};J.extend(fieldTypeHandler,evetMapping);evts=fieldTypeHandler[instance.type];typeof evts==='function'&&(evts.call(instance));};MOrder.renderPagelet=function(fieldsConfig,template){var cont=[],wrap;!template&&(template='{PAGELET}');for(var x in fieldsConfig){cont.push(MOrder.renderBlock(fieldsConfig[x]));}
cont=template.replace(/{PAGELET}/g,cont.join(''));return cont;};MOrder.renderBlock=function(fieldsConfig,template){var cont=[],instance,fields,fieldItem,titleTpl,isExpandable;!template&&(template='<div class="area _block">\
    {TITLE}\
          {BLOCK}\
      </div>');fields=fieldsConfig.fields;isExpandable=!!fieldsConfig.expandable;J.each(fields,function(k,curfield){var tpl;typeof curfield==='undefined'&&(curfield={});tpl=MOrder.renderSlot(curfield,curfield.tplSlot);tpl&&cont.push(tpl);});if(fieldsConfig.title){titleTpl='<div class="lump lump-tit _blocktitle" '+(isExpandable?'opt="_blockexpand" style="cursor:pointer" title="点击收起"':'')+'>\
             <h3>{TITLE}</h3>{EXPAND}\
            </div>';isExpandable&&(titleTpl=titleTpl.replace(/{EXPAND}/g,'<span class="hide"><span class="arrow"></span></span>'));titleTpl=titleTpl.replace(/{TITLE}/g,fieldsConfig.title);}else{titleTpl='';}
cont=cont.length>0?template.replace(/{BLOCK}/g,cont.join('')).replace(/{TITLE}/g,titleTpl):'';return cont;};MOrder.renderSlot=function(fieldConfig,template){var cont=[],instance,fieldItem,helpicon,newicon,name=fieldConfig.name;if(!fieldConfig){throw'Error field config.';}!template&&(template='<div class="lump _blockcontent">\
    <p class="item">{TITLE}{HELPICON}{NEWICON}</p>\
             <div class="detail">{SLOT}</div>\
   </div>');instance=new GDT.Field(name,fieldConfig.type,fieldConfig.items,fieldConfig);if(instance.forbidden){return'';}
J.isArray(name)&&(name=name.join(GDT.ENV.SELECTOR_KEY_KEY));MOrder.fieldInstance[name]=instance;MOrder.instanceToInit.push(instance);MOrder.delegateEvent.add(name,fieldConfig.delegate);if(typeof fieldConfig.helpIcon==='string'){helpicon=fieldConfig.helpIcon;}else{helpicon=fieldConfig.helpIcon?'<i class="icon ico-help" rel="order.{FIELD}"><i></i></i>':'';}
if(typeof fieldConfig.newIcon==='string'){newicon=fieldConfig.newIcon;}else{newicon=fieldConfig.newIcon?'<i class="icon ico-new" rel="{FIELD}"><i></i></i>':'';}
cont=instance.genHtml();cont=cont?template.replace(/{HELPICON}/g,helpicon).replace(/{NEWICON}/g,newicon).replace(/{FIELD}/g,name).replace(/{SLOT}/g,cont).replace(/{TITLE}/g,fieldConfig.label):'';return cont;};var orderCacheData={};MOrder.getOrderCacheData=function(fields){var value;if(J.isArray(fields)){value={};J.each(fields,function(i,field){value[field]=orderCacheData[field];});}else{value=fields?orderCacheData[fields]:orderCacheData;}
return value;};MOrder.setOrderCacheData=function(field,value){if(arguments.length>1){orderCacheData[field]=value;}else{J.extend(orderCacheData,field);}};MOrder.clearOrderCacheData=function(fields){if(typeof fields!=='undefined'){MOrder.delOrderCacheData(fields);}else{orderCacheData={};}};MOrder.delOrderCacheData=function(fields){!J.isArray(fields)&&(fields=[fields]);J.each(fields,function(i,field){var ukey;orderCacheData[field]=null;delete orderCacheData[field];ukey='userrules['+field+']';if(ukey in orderCacheData){orderCacheData[ukey]=null;delete orderCacheData[ukey];}});};MOrder.realtimeTxtCounter=function(id,opts){var fieldEl,min,max,wrapId,typeFn,checkInputFn;opts=opts||{};fieldEl=typeof id==='string'?J('#'+id):J(id);id=fieldEl.attr('id');wrapId=id+'CounterWrap';min=opts.min;max=opts.max;if(fieldEl.length<1){return;}
if(J('#'+wrapId).length<1){var len=(fieldEl.val().length||0);fieldEl.parent().append('<span id="'+wrapId+'" class="somets c-tx3"><strong id="'+wrapId+'CurrentLength">'+len+'</strong>/<span id="'+id+'MaxLength">'+max+'</span></span>');}
checkInputFn=(function(opts){return function(){var len,warn=false,min,max,cfg,getMinMaxConfig,wrap=J('#'+wrapId+'CurrentLength');len=this.value?this.value.length:0;getMinMaxConfig=opts.getMinMaxConfig;typeof getMinMaxConfig!=='function'&&(getMinMaxConfig=function(){return{min:opts.min,max:opts.max};});cfg=getMinMaxConfig();min=cfg.min;max=cfg.max;if(len>0){(len<min||len>max)&&(warn=true);if(warn){wrap.addClass('c-red');opts.onError&&opts.onError.call(this);}else{wrap.removeClass('c-red');opts.onSuccess&&opts.onSuccess.call(this);}}
wrap.html(len||0);opts.onInput&&opts.onInput.call(this);};})(opts);typeFn=function(){var id='realtimeTxtCounter'+this.id;clearTimeout(MOrder._timerCache[id]);MOrder._timerCache[id]=setTimeout((function(el){return function(){checkInputFn.call(el);};})(this),100);};fieldEl.bind('keyup',typeFn).bind('keydown',typeFn).bind('keypress',typeFn).bind('propertychange',typeFn).bind('change',function(){var m=this.id.match(/\_(\d+?)\_/);if(J.inArray(this.name,['desc','title'])!=-1&&m&&m[1]&&J.inArray(parseInt(m[1],10),GDT.ENV.NONEEDTOCLEANFULLSPACE_CRTSIZE_ARR)!=-1){this.value=GDT.util.trimWithoutPreEmSpace(this.value);}
else{this.value=J.trim(this.value);}
typeFn.call(this);});typeFn.call(fieldEl.get(0));};MOrder.targeting={build:function(fields){}};MOrder.pageaction='add';MOrder.setPageAction=function(action){MOrder.pageaction=action;};MOrder.getPageAction=function(){return MOrder.pageaction;}})(GDT.modOrder={});